### A Pluto.jl notebook ###
# v0.19.22

using Markdown
using InteractiveUtils

# This Pluto notebook uses @bind for interactivity. When running this notebook outside of Pluto, the following 'mock version' of @bind gives bound variables a default value (instead of an error).
macro bind(def, element)
    quote
        local iv = try Base.loaded_modules[Base.PkgId(Base.UUID("6e696c72-6542-2067-7265-42206c756150"), "AbstractPlutoDingetjes")].Bonds.initial_value catch; b -> missing; end
        local el = $(esc(element))
        global $(esc(def)) = Core.applicable(Base.get, el) ? Base.get(el) : iv(el)
        el
    end
end

# ╔═╡ 67cb574d-7bd6-40d9-9dc3-d57f4226cc83
begin
	import Pkg
	Pkg.activate("..")
	using Revise
end

# ╔═╡ b6abba94-db07-4095-98c9-443e31832e7d
using Optimisers, StatsBase, Zygote, ForwardDiff, Enzyme, Flux, DifferentialEquations, Functors, ComponentArrays, Distributions, ParameterSchedulers, Random

# ╔═╡ d1440209-78f7-4a9a-9101-a06ad2534e5d
using NeuralSDEExploration, Plots, PlutoUI, ProfileSVG

# ╔═╡ db557c9a-24d6-4008-8225-4b8867ee93db
Revise.retry()

# ╔═╡ 32be3e35-a529-4d16-8ba0-ec4e223ae401
md"""
Let's train a Neural SDE from a modified form of the simple zero-dimensional energy balance model. First, let's just instantiate the predefined model from the package...
"""

# ╔═╡ f74dd752-485b-4203-9d72-c56e55a3ef76
ebm = NeuralSDEExploration.ZeroDEnergyBalanceModel(0.425, 0.4, 1363, 0.6 * 5.67e-8, 0.14)

# ╔═╡ cc2418c2-c355-4291-b5d7-d9019787834f
md"Let's generate the data and plot a quick example:"

# ╔═╡ dd03f851-2e26-4850-a7d4-a64f154d2872
begin
	n = 1000
    datasize = 200
    tspan = (0.0f0, 10f0)
end

# ╔═╡ c00a97bf-5e10-4168-8d58-f4f9270258ac
solution = NeuralSDEExploration.series(ebm, shuffle(range(210.0f0, 320.0f0, n)), tspan, datasize)

# ╔═╡ 1502612c-1489-4abf-8a8b-5b2d03a68cb1
md"""
Let's also plot some example trajectories:
"""

# ╔═╡ 455263ef-2f94-4f3e-8401-f0da7fb3e493
plot(reduce(hcat, [solution[i].u for i in 1:10]))

# ╔═╡ f4651b27-135e-45f1-8647-64ab08c2e8e8
md"""
Let's normalize our data for training:
"""

# ╔═╡ aff1c9d9-b29b-4b2c-b3f1-1e06a9370f64
begin
    datamax = max([max(x.u...) for x in solution]...)
    datamin = min([min(x.u...) for x in solution]...)

    function normalize(x)
        return ((x - datamin) / (datamax - datamin))
    end

    function rescale(x)
        return ((datamax - datamin)) + datamin
    end
end

# ╔═╡ 9a5c942f-9e2d-4c6c-9cb1-b0dffd8050a0
timeseries = [(t=ts.t, u=map(normalize, ts.u)) for ts in solution]

# ╔═╡ da11fb69-a8a1-456d-9ce7-63180ef27a83
md"""
We are going to build a simple latent SDE. Define a few constants...
"""

# ╔═╡ 22453ba0-81a7-43f6-bb80-91d3c991530d
context_size = 4 # The size of the context given to the posterior SDE.

# ╔═╡ d81ccb5f-de1c-4a01-93ce-3e7302caedc0
hidden_size = 20 # The hidden layer size for all ANNs.

# ╔═╡ b5721107-7cf5-4da3-b22a-552e3d56bcfa
latent_dims = 3 # Dimensions of the latent space.

# ╔═╡ 9767a8ea-bdda-43fc-b636-8681d150d29f
data_dims = 1 # Dimensions of our input data.

# ╔═╡ 39154e76-01f7-4710-8f21-6f3a7d3fcfcd
md"""
The encoder takes a timeseries and outputs context that can be passed to the posterior SDE, that is, the SDE that has information about the data and encodes $p_\theta(z \mid x)$.
"""

# ╔═╡ 847587ec-9297-471e-b788-7b776c05851e
encoder = Flux.Chain(Flux.LSTM(data_dims => 6), Flux.Dense(6 => context_size)) |> f64

# ╔═╡ 95f42c13-4a06-487c-bd35-a8d6bac9e02e
@bind i Slider(1:length(timeseries))

# ╔═╡ 63632673-4374-450c-a48d-493ae7a6b1ce
begin
	Flux.reset!(encoder)
	example_context = encoder(reshape(timeseries[i].u, 1, 1, :))[:, 1, :]
end

# ╔═╡ 016ab596-424b-4c50-b5c0-46d08aa47909
plot(example_context')

# ╔═╡ bdf4c32c-9a2b-4814-8513-c6e16ebee69c
plot(timeseries[i].u, legend=nothing)

# ╔═╡ 0d09a662-78d3-4202-b2be-843a0669fc9f
md"""
The `initial_posterior` net is the posterior for the initial state. It takes the context and outputs a mean and standard devation for the position zero of the posterior. The `initial_prior` is a fixed gaussian distribution.
"""

# ╔═╡ cdebb87f-9759-4e6b-a00a-d764b3c7fbf8
initial_posterior = Flux.Dense(context_size => latent_dims + latent_dims) |> f64

# ╔═╡ 3ec28482-2d6c-4125-8d85-4fb46b130677
initial_prior = Flux.Dense(1 => latent_dims + latent_dims, init=Flux.glorot_uniform) |> f64

# ╔═╡ 8b283d5e-1ce7-4deb-b382-6fa8e5612ef1
md"""
Drift of prior. This is just an SDE drift in the latent space
"""

# ╔═╡ c14806bd-42cf-480b-b618-bfe72183feb3
drift_prior = Flux.Chain(
	Flux.Dense(latent_dims => hidden_size, tanh),
	Flux.Dense(hidden_size => hidden_size, tanh),
	Flux.Dense(hidden_size => hidden_size, tanh),
	Flux.Dense(hidden_size => latent_dims, tanh),
	Flux.Scale(latent_dims)
) |> f64

# ╔═╡ 64dc2da0-48cc-4242-bb17-449a300688c7
md"""
Drift of posterior. This is the term of an SDE when fed with the context.
"""

# ╔═╡ df2034fd-560d-4529-836a-13745f976c1f
drift_posterior = Flux.Chain(
	Flux.Dense(latent_dims + context_size => hidden_size, tanh),
	Flux.Dense(hidden_size => hidden_size, tanh),
	Flux.Dense(hidden_size => latent_dims, tanh),
	Flux.Scale(latent_dims)
) |> f64

# ╔═╡ 4a97576c-96de-458e-b881-3f5dd140fa6a
md"""
Diffusion. Prior and posterior share the same diffusion (they are not actually evaluated seperately while training, only their KL divergence). This is a diagonal diffusion, i.e. every term in the latent space has its own independent Wiener process.
"""

# ╔═╡ a1cb11fb-ec69-4ba2-9ed1-2d1a6d24ccd9
diffusion = [Flux.Chain(Flux.Dense(1 => 4, softplus), Flux.Dense(4 => 1, sigmoid)) |> f64 for i in 1:latent_dims]

# ╔═╡ bfabcd80-fb62-410f-8710-f577852c77df
md"""
The projector will transform the latent space back into data space.
"""

# ╔═╡ f0486891-b8b3-4a39-91df-1389d6f799e1
projector = Flux.Dense(latent_dims => data_dims) |> f64

# ╔═╡ 001c318e-b7a6-48a5-bfd5-6dd0368873ac
latent_sde = LatentSDE(
	initial_prior,
	initial_posterior,
	drift_prior,
	drift_posterior,
	diffusion,
	encoder,
	projector,
    tspan,
	EulerHeun();
	saveat=range(tspan[1], tspan[end], datasize),
	dt=(tspan[end]/datasize)
)

# ╔═╡ 05568880-f931-4394-b31e-922850203721
ps_, re = Functors.functor(latent_sde)

# ╔═╡ 5b073f11-08bd-4128-85c6-7f043b60bdb8
# ╠═╡ disabled = true
#=╠═╡
ps = ComponentArray(ps_)
  ╠═╡ =#

# ╔═╡ bd8fbd96-d945-4ba0-a389-d75d382438c5
ps = ComponentVector{Float64}(initial_prior_p = [0.27968024906723715, -0.4411645404072119, 0.3581804833553204, 0.3838009972585425, -0.3869362416719037, -0.40506976048453125, -0.19027525487334576, 0.43617416703984135, -0.39446036003609863, -0.39510761308539033, 0.30524063678039776, 0.4346003611852397], initial_posterior_p = [-0.7209120392799377, -0.060817498713731766, -0.4154626131057739, 0.21080227196216583, 0.5869414210319519, -0.6983190178871155, -0.36968937516212463, -0.6831527948379517, -0.5928301811218262, -0.3418050706386566, -0.4378199279308319, 0.24985766410827637, -0.5649783611297607, 0.35832998156547546, -0.7011997699737549, -0.02677474357187748, -0.027573755010962486, -0.5726481676101685, 0.42148590087890625, -0.7033055424690247, 0.6333048343658447, -0.35436883568763733, 0.03166317567229271, 0.004290352575480938, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], drift_prior_p = [-0.44581059745642704, -0.24025162229525665, 0.40032057760218975, -0.035825831346368214, 0.28414859376576723, -0.17338254553257257, 0.03784610842614539, -0.17914831905420947, 0.5725720111685473, 0.3647711384205138, -0.22199343660718526, -0.49173103664831364, 0.29731086134144824, -0.3262854837540253, -0.3739581683674867, -0.4109902607035163, 0.028320663817284937, -0.04348274932579274, 0.2207416926279013, 0.5664569644175305, -0.3082570664974679, 0.4885409457313624, -0.126310277364478, -0.5646373000264345, -0.4626140274116532, -0.2333172694669011, 0.1928236961852999, -0.21559977694830557, 0.09402510575541029, -0.2064164444594874, -0.4533573573059839, -0.16421754680515144, -0.5344684478626877, -0.13254322675841068, 0.08473696860939608, -0.3538005250421305, -0.4351131163202559, 0.1775280290690387, -0.14293650190830154, 0.09303062462238036, -0.0475131910300876, -0.311531214628266, -0.2593021749315061, 0.3536592353849754, -0.29518859104914713, -0.3892703294427218, -0.04312813105469118, -0.2806799127175331, -0.3799837093563559, -1.0519206687265623, -0.16369057123431321, -0.4046336181889681, 0.1451593852160878, 0.1998844052441709, -0.5090331994337886, -0.5764091714955165, 0.16043142727133336, -0.5377012636683826, -0.3893812722266807, -0.2593482882295406, 0.015525183838344017, -0.1680879912883364, 0.10069528299457908, 0.3648714418304144, 0.03454083875517932, -0.17964351875051526, -0.0934283717054559, -0.06897127731478091, 0.10521957152855936, -0.09976957952317624, -0.03497001340669986, -0.10075872775777692, 0.16105178832900088, -0.22236496838161057, 0.10855082148855259, -0.19928031475809807, 0.07962098949467449, -0.32605871976024525, -0.10747183719743975, -0.03083833862753652, 0.18797781492222201, -0.059437089316119116, 0.278884227577316, 0.33336898018036126, -0.1632231254113165, -0.16209962541489642, 0.16806408388278693, -0.1656735256894199, 0.17719461318233126, 0.3202354685524088, 0.1286282261638662, -0.17692560539277896, -0.0762730234944382, 0.2668278068081074, 0.37942659056777817, 0.20183535396370642, 0.011107838513117934, -0.25446238776230257, 0.24967221715012186, -0.15695454781037965, -0.3813470939264111, -0.2844207619167499, 0.03477713833891316, -0.08751567033218499, -0.28719672883254577, 0.22274326075713977, -0.03138301820158231, 0.24508118714074453, 0.13930095185013106, -0.16908628838911482, -0.24455732866905672, -0.357465293903966, -0.1222120147733329, -0.028897157809653188, -0.2516663964631559, -0.31497725048764363, 0.07372030893759361, -0.00700126606222373, 0.4073303420147128, -0.02277377816072316, 0.15506447084944805, -0.164438879939074, -0.39549669876647586, -0.09760775975810518, 0.33628461958557415, 0.1740377256758282, 0.35339635508639705, 0.09021838194480783, -0.24722209112411891, -0.4977982534002523, -0.6921019170903552, 0.6551373847743897, 0.0496182423518407, 0.43273114303014026, -0.31282197909610937, 0.46327551448413085, -0.1896651335904847, 0.2700552346399448, 0.2689155669650008, 0.5152205208608229, 0.3838109869727839, -0.0027532704005082884, 0.1744073858489011, 0.08402082598487064, -0.2583927401529682, 0.030223698502107457, -0.5765782318802533, -0.11973237012516846, 0.29140746884785085, -0.19121998028200463, 0.025142870939610023, 0.12709239234923586, 0.08128768190977859, -0.15356996515016857, -0.23136201477905763, 0.21278026185088286, -0.17271840256581433, 0.026145898310691317, -0.21301499135521967, -0.012356818481515904, -0.2162459115430547, 0.027973272996858922, -0.2799810461061122, 0.49755766125871836, -0.19969416905250048, 0.09517807353968914, -0.06461301006571021, -0.4550480728491656, 0.22817990128874097, -0.3001980237473394, -0.2730667923331469, 0.29454673742621534, -0.26579938667363767, 0.44392489945949426, 0.11001975015392998, -0.13628306530642906, 0.19805696776468668, -0.087122706152024, 0.1027182718135854, 0.4614884857567034, 0.17819045866371613, 0.4167965430851787, -0.30359127133556185, 0.2747880652127614, -0.18550882233733268, 0.14580870062341303, -0.12778760218701832, 0.23303715075787784, -0.07898638681375547, -0.38837183129873476, -0.1603867430338245, 0.20785374963353068, 0.08583163917653461, -0.024454891732263215, -0.27180122232180703, 0.38344168240198345, -0.0596084593433161, -0.3304731993875345, 0.6874218863590222, -0.10498505438877695, -0.0290190039623367, 0.1241566956433915, -0.21287183626374398, -0.31659493382415643, -0.22369097635820792, -0.26589169545124286, -0.13569298404597532, 0.3217769214782239, -0.027290922133591893, 0.09630199718179781, 0.24616615349982382, -0.2573850156206271, 0.05239584979707328, -0.5815668277332225, 0.240546675404745, 0.06472045430993471, 0.2264108171356671, -0.0037593921646576966, 0.3054862428835323, 0.2366530911391107, -0.08569177226071642, 0.22535493077242716, -0.14906306785367046, -0.17089636596193872, 0.29892677401023443, -0.10316914882704485, 0.04816041071368156, 0.18409458213965169, 0.2220211120843503, -0.5801805065175177, 0.09168918745508287, 0.1566931808901411, -0.20886688061479736, -0.19996562245218077, -0.19098766958389995, 0.3724648243597628, 0.11590231605736415, -0.6893110767199487, 0.1409519548361185, 0.02213144630391024, -0.1088480177410849, -0.06957216696299534, 0.11400852472990713, -0.09890337906419999, 0.1105686558127832, 0.1767493625015219, 0.21404916769853571, -0.3750207250775965, 0.24577213280012683, -0.1562452063067383, -0.5728258699175929, 0.561101782076355, -0.4006026865312298, 0.2553272856089831, 0.1458227586424415, 0.5094936506877709, 0.3624475551982417, 0.30350745438886517, 0.03337915289206392, 0.35160656958081804, 0.0053957926180525145, -0.009043972097431147, -0.28397007426250825, 0.3410305077778985, 0.01925176923864136, 0.3640597385713426, 0.08358999388643269, -0.0712225316598043, 0.015378303324843152, -0.22049789017999466, 0.1674332490339602, -0.287363751852603, -0.005850769188472235, -0.21488880919875986, 0.16149963495629763, -0.2613599619498158, 0.15132622845658716, 0.3481273577848265, 0.5420417597986275, -0.09748486080154593, -0.07613202849504969, -0.16267522401977325, -0.42838398449919046, -0.27618649172831095, 0.17890662822766046, -0.18846554738463092, -0.396315720675238, -0.04940043013116576, 0.32267588772088895, 0.23106919545548335, -0.15114673300095466, 0.2955132378864599, -0.31486371459293716, -0.15557242800931664, 0.16358331254621825, -0.023662709522299506, 0.20206188093215902, -0.1830951571966619, -0.24833552297555442, 0.1227486214948538, 0.1734972932694239, -0.2576260348547622, -0.055695434467192086, 0.26740125764010425, -0.30834410257630546, 0.0015323549886568743, 0.4254031782152147, -0.03586642516933747, 0.07940154520019, 0.15643688135361494, -0.394647533253858, 0.3347883745448896, 0.09848409578005674, 0.20226760620976872, 0.18077905521122029, 0.22252231309858758, 0.2019370665166118, -0.1829047744822199, 0.020972897721096468, -0.29416757995963416, 0.09319271380416187, 0.0225799732179461, 0.12380742259006736, -0.351030404071975, 0.2592462117618433, -0.16157366489821492, -0.12468675410432108, -0.5076959009372216, -0.21550884840435686, 0.21604268677233274, -0.4498885704310007, -0.17431704624550062, -0.04395222902161309, 0.5071139406771688, 0.19085821932289945, 0.038428405221087196, -0.18145170448118658, 0.05714400760763822, -0.0253380545919035, -0.03993093675560581, -0.1079317158970897, 0.2535312709364182, 0.05119881876514841, -0.06216991745148576, -0.20656575184343562, 0.15137997293084676, 0.10992760453697184, 0.40290734030009573, -0.06920361396902758, 0.2243563210178947, 0.3175843770754465, 0.3061054672074835, 0.3234373959916868, -0.44804294620700197, -0.20432222409593992, -0.055381817393105895, -0.01179309023853631, -0.3276607735586555, 0.1512523820596843, -0.4698379089936747, 0.3120808420252434, -0.22833514481533762, -0.04243088107216783, 0.45234900029778985, 0.17455145882972803, 0.04382857206295488, 0.2551029011418225, -0.324221154268947, -0.294473717276716, 0.4183022881715356, 0.17312300634165748, -0.010827467273362599, -0.3205585545623059, -0.33795179564354044, 0.16339357938005666, -0.04824607901713013, -0.1667368529935503, -0.27470368859080746, -0.14763220840578598, 0.2772402739274747, 0.19903166336761854, -0.29941145897207727, -0.551062897567023, 0.37583412240326997, 0.20585681984266435, 0.017390420424107714, 0.40377036464039034, 0.01743090338460203, 0.009254262820150152, -0.313452782468353, 0.233199841396987, -0.2602671789786283, -0.025245938516665855, -0.19964451041234407, 0.026153580824358907, 0.11766494421031523, 0.34905464538239, -0.5657540413222805, 0.15253802825300397, -0.20128171682961146, 0.24444233272231933, -0.2890782034740422, 0.28188016448741354, 0.2322678928600028, 0.11731534603497677, -0.14124478256901082, -0.3973684611679494, -0.28102549760835044, 0.24245086513403405, -0.1265820526584795, 0.26328266903033565, -0.3251734766462087, 0.04696729111155213, 0.3980916299834312, 0.13104510115725418, 0.144027631698141, 0.16095453084401187, 0.10937170334266016, -0.0031198295322712203, 0.1258949750674604, -0.26476570307425135, 0.2906966931781961, -0.33603334895924447, 0.08446627553924979, -0.2228651159216051, 0.135310460434191, 0.5169281224192144, -0.03348378103741228, 0.062384634422448945, 0.05611143965385557, -0.052054992773054, 0.2741680856361747, -0.151334284714223, -0.41652433129962324, 0.34105117539342933, -0.1696660090938646, -0.06604465524958907, -0.1879465950779777, 0.42834120596131303, 0.02805107445277299, 0.04372141291979962, -0.2562472500693467, -0.05998661335008477, 0.4671542398152206, 0.025010588475983028, 0.1926581465612718, -0.1302710631949949, 0.2735837634608128, -0.15937977526962266, -0.255100502389243, 0.1444909368316741, 0.21410073494217152, 0.07128171802016485, 0.09265289558683508, 0.29872035171948713, 0.3476496917253786, 0.2909335895929476, 0.16979094509579407, 0.3158888206575472, 0.318620951909828, 0.15178428112776898, 0.3760879143007171, -0.40267645074644304, 0.19773669760699467, 0.4131018322638075, -0.48431609464353015, 0.2629256951046814, 0.0633105875601028, -0.37520843844997026, -0.21265961157000352, -0.3364660840799626, -0.20659284945810227, -0.05692989451854435, 0.37034997726780844, -0.09227547587045004, 0.4115255579951212, 0.043274537332835254, 0.4084910671807024, 0.06908080776661295, 0.03381336218354551, 0.12978447254583417, -0.044219217861412904, 0.136443162319998, -0.06882013347654493, 0.013797733868016394, -0.08095002274314891, -0.12229906975448852, -0.138490020744005, -0.03908874996659591, -0.0564353222750474, 0.03253809230813751, 0.03278607731053588, -0.042711392155847384, 0.10284111415834232, 0.03520816981275371, 0.04787871479447817, -0.11059748649061815, -0.24848520842198896, 0.04285010601743044, 0.04798533252992148, 0.18875071318481962, 0.16770709538474185, -0.08711011081132466, -0.18061611827109272, -0.36008238464254744, 0.15975129428960294, 0.09748783396325757, 0.3811972045331499, -0.2333697863475326, 0.09587618523093137, 0.2744643735132975, 0.22215396490500833, 0.10409395642766338, -0.13423213400638828, -0.18929613603123638, -0.20401345617361347, 0.36462833320987803, 0.05615431833612094, -0.39072479273387994, 0.3237720592958334, -0.1793183505950321, -0.13885490069787762, 0.36748951119190226, -0.29684195611036607, 0.03001777794922766, 0.30772071824789127, -0.3695954517469551, -0.18984656716593815, -0.17302366687988213, -0.4162334083589242, -0.31301810962546917, 0.048738925982530115, 0.09301546916847368, -0.042275026134499, -0.4873767989900237, 0.1644530168589041, -0.24375700082880633, -0.1177212108120231, 0.3158176579155562, 0.19404207294673712, 0.22642939413507163, 0.21133560594999404, 0.21933185308100805, 0.43838334581435257, -0.24841497411911645, -0.2961448931510226, 0.14593242328480938, -0.22946582149529457, 0.030846997793678804, -0.10475855129704316, 0.09282967605053728, -0.07060226245259742, -0.40065884751635716, 0.21097502355111072, 0.21909177788591896, 0.3231549937600527, -0.2992400368297065, 0.22569035430524156, 0.02023903216624509, 0.10401914924068774, 0.3237998675319408, 0.03964794634483964, -0.30732436305013033, -0.20784677307046506, 0.4358269367906792, 0.305896956303313, -0.15152541766009558, 0.025613249141041405, -0.217540683273982, 0.19167926230828647, -0.3935229768439929, 0.16204485494883822, -0.31264201782059836, 0.22535040413131094, -0.26044355019697485, 0.037243506649093774, -0.3516032441029132, 0.016814946943031987, 0.1409608632931769, 0.19461252932506895, 0.14123617883816048, 0.013312104749796333, -0.3251032121484741, 0.046356825435365435, -0.49472880407793807, 0.40276430186773743, -0.21500520844554988, -0.366077358243261, -0.12370365628978944, -0.2269971125665465, 0.19842590287086262, 0.15639034816370928, 0.20815148596056837, -0.27040792114348783, -0.021854669417480127, -0.07411757825614491, 0.3082240821556968, -0.3431645278832753, 0.1260750471603978, 0.52667145705481, 0.19977024152572723, -0.14338883869769875, 0.17915388495813628, -0.07321444414184206, -0.05323965432416922, -0.027209918648856968, -0.010942890300493934, 0.014763968191664575, 0.3914244437930327, 0.10750282788707813, 0.05325150402021642, 0.4970374141136223, -0.23218136308900966, 0.026938506699124596, -0.39618709797815377, -0.1151944779863444, 0.265085827654915, -0.05195755742111574, 0.22644709346113623, 0.006580803449714357, 0.17365381464702476, 0.038024999721780944, -0.22634506898652998, 0.08554125266766364, 0.28579903414060687, 0.03418465424342266, 0.39281566117254846, 0.3233565480249481, -0.2789909345165589, -0.22677960496209873, -0.07000704985569974, 0.25987316055281134, 0.3732534039630542, -0.23036321612417981, 0.4483397967082071, 0.12860817869730282, 0.18235696340417246, 0.2694404214211781, -0.3171181364307858, 0.37238588872439643, -0.2899938976746885, 0.12199351022425205, -0.3102754867599751, -0.14079480456208693, 0.5739772924402607, 0.232135446434024, 0.038187912654172894, 0.3781779329597092, -0.1152965156549367, 0.5747178177101246, 0.09989194888463943, 0.13986969079055084, -0.3790010525800499, -0.15632805038435096, -0.1136335003770743, -0.18613474450506953, -0.6510269962434998, -0.188279606570401, 0.4111050908730181, -0.45825374627693993, 0.32606277226564706, 0.47304511098295293, 0.1885898110356205, -0.08277969442394262, -0.13407920594275094, 0.008602760402095387, -0.32333640418079784, 0.3606089984063599, -0.026489721626444616, 0.12599969147418166, 0.38388053362585695, 0.48157308603335525, -0.2581960963104231, -0.32085539829239385, 0.37691050573345836, 0.07082894398472853, 0.05012554757714309, 0.3849826572210196, -0.3813995419889539, -0.23907639189178317, 0.21936939677461426, 0.2838124467454239, -0.11332890304422343, -0.09248140878354241, -0.18812917263660148, 0.18327008072223397, 0.3520746960987992, 0.10492119751964574, -0.16779967939872234, 0.1434747794838559, 0.3403896948117297, 0.16384432475003624, 0.04445340638650449, -0.1608038482716089, -0.17451321823058655, -0.2672901323138947, -0.10088312710419192, 0.12036726803353137, 0.44711246152239603, -0.00943260640435529, -0.3409058517112422, 0.15208133293665146, 0.1311520490364008, -0.46411303958232764, 0.012327511523501243, 0.0029354043312214847, 0.046072760575365364, 0.06130992923636938, 0.19504000551842207, 0.16606458967669574, 0.15481654901592826, -0.19883617800238138, -0.3527310519743254, 0.5716347382525974, -0.3266853413528741, -0.14931440889338166, 0.23068891638778888, 0.26256945283686384, 0.38104302145753294, 0.08403796758055575, 0.17484780347087003, 0.09355385190190227, -0.18487113960136525, 0.2569162273120765, -0.014844850673478292, 0.18516309661648098, -0.051302579922069144, -0.3263462753637433, 0.3087233684527599, -0.10586551667041903, -0.3529625732511631, 0.3339891274592132, 0.1172823560505916, -0.18730283584313207, 0.4214045906901607, 0.4131854240884431, -0.08786976886121381, 0.09712021810241919, -0.06077739284102005, -0.17883739528240628, -0.32910082433425447, 0.11599312677350584, 0.07372058857070944, -0.2512667204761261, 0.07104639172823828, -0.06623752833927771, 0.07649588799588596, -0.2842892407081436, -0.34005972526614825, 0.02683865812658419, -0.01145452487596984, -0.043846675349611855, -0.0050309836495142255, 0.22890694506660547, 0.26053113530897803, -0.11690151667591078, -0.0027670065783712036, 0.22566259780152484, -0.10739543857296606, 0.042770514922076106, -0.07334377394131696, 0.056698396606830105, 0.3203159886322931, 0.5190391241393572, -0.10068411429076557, 0.27675761735641696, -0.15801462551365494, 0.13093828948572497, 0.01674681696704999, 0.020637482103561675, 0.015186305707710478, 0.466859384026632, -0.15312030620747655, 0.2855409846698452, -0.0731310766953025, 0.1964410466508266, 0.3816098850771693, -0.1918490950090234, -0.29992792444440186, 0.13139996782647437, 0.297537181387431, 0.2800194219778505, -0.42739360983495833, -0.03210877579187677, 0.5642869841220644, -0.07837002070894229, 0.008685541509917067, -0.016741748512346635, 0.19439675280391983, -0.11474061099986622, 0.3065435257783605, 0.4410481917919134, -0.05766303656266362, 0.11172118172286154, 0.05536127113732751, 0.14382269194657332, 0.1921041806317711, -0.28943908883582886, -0.406698174238501, 0.1597039683597527, -0.0359401988594944, -0.17617891394142207, 0.00012366644651713217, 0.4788513387842073, -0.057536645050170115, -0.0642932809621385, 0.10954345748467577, -0.24705155266423812, 0.10504124540109121, -0.36313392034582986, -0.3415556114033884, 0.34920456073306366, 0.39254506433486774, -0.24078440661713943, -0.04588563997602965, -0.13817407161418227, 0.20606663018087967, 0.0480230281504889, 0.02775872103615152, 0.34533183548121826, -0.12507454361761963, 0.2347255368080192, -0.1557798578224862, 0.2766382081142208, 0.5536462829856515, -0.09314359219400103, -0.3674339408111776, 0.1272092498004042, -0.2711679918375344, -0.13324572074131397, 0.04560358624114299, 0.0851281665553467, 0.045696812227209845, -0.2638780236570673, -0.09461354873600601, 0.37858306549989695, 0.04603489820628348, -0.02395431212999304, 0.298992486318494, 0.22303694980845062, 0.4299825483424864, -0.08207860659424583, -0.2014746660430184, -0.26750139415441687, 0.22671706502793695, -0.09588657575984513, 0.28305354049012094, 0.24666684805383363, -0.10181714880637399, 0.03373543705549914, -0.2421245955028224, -0.3509662615315315, 0.23355839384120577, -0.45683491378126556, -0.09933264769623139, -0.27549519156105495, -0.10101890772040159, 0.2461604350825401, -0.27741035987730167, 0.3524748643917776, 0.0677086421299099, 0.07563471491983044, -0.13916102954327833, 0.03364714611833387, 0.3515510810503908, -0.3272983750752911, -0.4171706423101736, 0.2926441304360755, 0.2836376131247853, -0.2185213794514054, 0.1408731680303337, -0.1417395085610849, 0.08452907960589566, -0.21582145246849904, -0.22001495630553056, -0.28722228054746807, 0.1640764231252338, 0.007839632420929455, 0.12984954735249998, -0.021940302033113226, 0.48398271544240806, -0.5441823898957014, -0.46614959783890636, 0.46275473757439045, 0.17952874496838903, 0.47399396428948654, 0.014735772775975594, -0.11951956250168667, -0.13341886442904538, -0.02790236170998641, -0.41501775957241754, 0.17031967135774678, 0.24734451839481433, -0.23481758020067842, 0.30267450189409795, 0.2900727378342046, 0.6701741054293994, -0.10952646989740984, -0.05999361938615618, 0.22400076941020722, -0.0069497818627389865, -0.030390500835171454, -0.04759165963702738, 0.02467726995817146, -0.09656885469567673, -0.0019369826845737665, 0.0025941470381111494, -0.06736936587442517, 0.0781329981386325, -0.1340993610289878, -0.022260266764866775, -0.015220764686765847, 0.044777284290212965, 0.02409027110353854, 0.05314405195332348, 0.09806901342100795, 0.2432459926320852, -0.03653828336309419, -0.04259871177888566, 0.009554443555633837, -0.022640025840499976, 0.43613018787866414, -0.24065022161351254, 0.579925456194018, 0.3084636004040587, 0.13935718881926018, 0.3478015869020725, 0.35193493592159203, -0.26882616777003016, -0.6697799617479235, 1.005920910592853, 0.0032812551876103234, 0.29449035840723226, 0.12727147228007799, -0.26541458251532113, -0.47957073200666533, -0.2221523225120719, -0.055252820520454674, -0.2564545911790958, -0.3327849556001545, 0.015140977222107162, 0.5269382657286102, 0.08086967047195702, -0.1613294363841029, 0.015584616744379208, 0.46737563645439756, 0.41178781900995454, 0.17330232727301698, -0.42365826334321, 0.5030174523854349, 0.6309980072485203, 0.23282264735483188, 0.48114600925380085, -0.07913001393799363, 0.21923614524815194, 0.8126459127658646, -0.6251312707546329, 0.33890073180049013, -0.8272039213742425, 0.16379996647436257, 0.38741760391918734, 0.5080647083630279, 0.12452710536886964, 0.07814428854081312, -0.8753607851109511, -0.2606634463012008, 0.40010421533434626, -0.6553064952554072, -0.3341576849095778, 0.5040211363515191, -0.3144341852433336, 0.48243526224836303, 0.24882735777127968, -0.3952324017083764, 0.04256866458310754, -0.6939668810629102, 0.691758020286816, -0.1090260132204527, 0.3366406429829906, -0.13782732970698203, -0.13000525793449422, 0.19674965350751789, -0.02006988704651409, 2.4759744075958494, 1.8673168744848023, 2.614568979899927, -0.3362999624743911, -0.009136046278940593, -0.14497542268420052], drift_posterior_p = [-0.09237842130712355, 0.06828521033214432, -0.1544637895595703, -0.17848858082793292, -0.19400196037578232, 0.14257637666612158, 0.020905845917718484, 0.2651174138913636, 0.4369791163077116, -0.20193619962437595, -0.48150176875386874, 0.11892934796588651, -0.2868685348063844, -0.06253955272325193, 0.06875324049357641, 0.92712505130177, 0.1161683499855673, 0.31013809587984675, 0.029967065850717914, -0.08939960685942351, 0.08001630262081966, -0.052754500470428255, -0.2636321533541961, 0.33706919528350726, 0.06410439751572677, 0.2805372151677947, 0.21959641883094325, -0.2464304601401787, -0.05003301401932426, -0.3703147862989408, 0.36834352983984103, 0.3876482540435124, -0.06129712065094465, -0.004992274441618289, 0.10185253884833675, 0.19540713593475625, -0.3204942382390346, 0.05581293353158156, -0.26729457996185857, -0.3627538510769756, -0.07159230121003296, 0.3769264085113427, 0.31137972641756273, -0.06875994989775663, -0.5785501921554113, 0.044939398325238133, -0.021133814370282295, 0.38861893975322453, 0.058883695302432544, -0.39632891501785716, 0.2569401114695587, 0.2561536449501062, 0.33850831556566535, 0.012201926778995233, -0.3507882726523984, -0.5470776568292249, -0.0761716402525348, 0.4112384917413573, -0.16628190326782588, -0.5437315143202939, -0.4274839738833285, 0.09194629185340239, 0.06421171450630078, -0.30350655794242365, 0.08705775718941931, 0.17508602834904552, 0.13422563254718234, -0.12193331141970663, -0.3387410110642459, -0.5625844952919695, -0.4114070934864143, 0.21638578583897447, -0.4146518302470009, 0.014450863629706517, 0.33667885012127236, -0.36664303032382517, -0.6072085631072695, 0.6885588498166627, 0.1800367645358459, 0.028403434961792436, 0.7618072240570358, -0.6969101578191316, -0.7590705133975817, 0.9043421204331757, 0.3389439928271088, -1.2686097283809379, 1.3321226991513428, -1.2001846773677463, 0.5434547982342868, -0.11223326195774654, -0.14561855214218314, -0.8023944149441093, -0.46032353151050537, -1.0778061652460045, 0.9120555167092018, -0.19319990947533536, -0.4537244992702823, -0.5396452975462975, 0.860624522307245, -0.8955220832528503, -0.7703160235540836, 0.374078068496926, 0.6377336726196078, -1.1555656728711396, -0.4425295159488433, 0.11643113718447481, -0.06085372920762473, 0.11484090572106222, -0.403629594828793, 0.14390734732375307, 0.15843915273171058, 0.5697083591185966, 0.8995672528267867, 0.4516833710388998, -0.8594931908530898, 0.3595993073478293, 0.29064472332365754, 0.6424212778153775, -0.5286598924469148, 0.36570863178760626, -0.08643930397098265, -0.4716242071034241, -0.004603280808570233, 0.21902798515243743, 0.2076396682075662, -0.497475148268956, 0.7437289614073469, 0.21724731721162313, 0.13490520070276027, -0.5643254957641829, -0.5826789370042113, 0.11622190583817622, -0.2052079024992627, -0.1327919714888509, -0.1417721487456914, -0.03146749878423547, -0.10132901066233882, -0.2746487461070701, 0.37084810753910763, -0.026949993333088226, 0.12076486513260273, -0.06990657375360378, -0.17430239662603375, 0.023006742107943044, 0.057647771905448245, -0.014284658497083677, 0.030099424696819244, -0.09464474076948995, 0.13846535046098932, 0.15382121799117734, -0.29386433578521853, 0.07337638461101005, -0.2289649879351097, -0.03802139231245037, 0.1527276925489699, -0.16333359633972816, 0.21202289792979184, -0.02803848302806409, 0.13819123866643812, -0.10247965261538794, -0.19886838235235552, 0.023335015257369293, -0.26266772397858223, 0.3840489048582769, 1.0707865891477444, 0.02359011113460405, 0.5501192951826614, -0.13945323470276857, -0.45848544034117583, 0.05751127938520882, 0.3879431894441289, 1.4429806467553377, 0.03636158887587887, -0.5307183905701474, -0.6706596714516946, 0.4299378119887927, -0.7529352330598911, 1.5221112542141582, -0.3876636964578998, 0.2980157796480656, -0.2612948650126893, -0.2602581649038333, -0.20659278718372162, -0.49844090251117046, -0.094747629949765, 0.24195142331435604, -0.08495128527686394, -0.25246935029754924, 0.2808544770981397, 0.22322717081044335, 0.15874089111666087, -0.043951924004215916, -0.06471597276798931, -0.2770318527708104, 0.19026092093081648, -0.23673189254809343, 0.2868329553166567, -0.017751342941506678, 0.6012280238423166, 0.42933723641053073, -0.5675269824554369, -0.2050738348709648, -0.019802991023453568, 0.12720656282112722, -0.37929721738214334, 0.21744763810554152, -0.4324663102892444, -0.3299608964055049, 0.44609975105265837, 0.36808319722313465, -0.3148754357198959, -0.6148929464541965, -0.5227344919190827, 0.37048720490029996, -0.37793543994952544, -0.2231019811508372, 0.6825077028900686, -0.442943321125479, 0.13943296359298601, -0.34706013650061196, -0.11107381334388428, 0.5862785853094956, -0.020573960572980787, -0.004308064020140389, 0.8761309646889522, -0.24760390084541684, 1.1832825314863653, 0.3483833543277445, -0.158005718490057, 0.46541294152583584, 1.3375771330876969, 1.6052077643909914, 0.6731640403645238, -0.5682068474991471, -1.0090197194739692, 0.15048299997625955, -1.1278252613644628, 1.2669618374468197, 0.05834164848422855, -0.13672063397145076, -0.05466648391654074, 0.08380469351018247, -0.21294658727032778, 0.4861858124869852, -0.2312482353431422, -0.24111957971106368, -0.10243722627587493, -0.1326143650509348, -0.35693113761357004, 0.034780921593077524, 0.37883987197588453, -0.08332050684723247, 0.18652649513862293, -0.14172723512175875, 0.19711096440737394, 0.04322782133322026, 0.12013889115554088, -0.23518176229432086, -0.197342066050046, -0.10623820265130583, 0.18416336593702662, -0.2492602068313485, -0.3157256036173155, -0.297573823930132, -0.40967451223434304, -0.037198458222402295, -0.27310004615019245, -0.3582369722995814, -0.12245325428828574, -0.2432916173022191, -0.1479487988761451, -0.3388877008240959, -0.3825331853351585, 0.3503255356160452, 0.3086352028370177, -0.05711304466416154, 0.2750024990845937, 0.27106328059759566, 0.386244454259007, -0.04817018043634224, 0.22093085333042034, 0.2763888146437881, 0.0501087091464868, 0.3227806060361014, 0.45674549297832556, -0.43324155858408403, 0.2370633526785595, 0.212183776206888, -0.254450712496653, 0.41913571621334245, 0.49727149768608664, 0.3141323665707526, 0.3730397552892005, -0.44461179194145833, -0.5701218027922991, 0.10329551480725195, -0.838564484599247, 0.6652923172749934, -0.023230561309196932, 0.11995086631588747, 0.31609172070326863, -0.15078786131453753, 0.24181077831449763, -0.1673393818825402, -0.11024115535344928, 0.02342565195690509, -0.20872601318406292, -0.3595346038600521, -0.4500955539620518, -0.07400701300131003, -0.1246911682773173, -0.07558727321310307, 0.06695065391491847, 0.0917392678840051, -0.001504347487889078, 0.01994631642533859, 0.63170927987601, -0.590736254912724, 0.60701142654454, -0.346680852564289, 0.3731811296567266, 0.5535324028661042, -0.20617941712464533, 0.15740032790512817, -0.03842970425812826, -0.05398375692595257, 0.5795101916413902, 0.4511405337405434, 0.36984832128051326, 0.21277040497108995, -0.014051848556543045, -0.13961767329774322, 0.38865705323935745, -0.48293403922049694, 0.12724075484757916, 0.14659888641323351, -0.7276218291551234, 0.01906617251422577, 0.1522968099827091, 0.26494876314700416, -0.20927727245006542, -0.2030373128098386, 0.08377054958358661, 0.04505397219965623, 0.06321595238849158, -0.3501308419467552, -0.12365804644065041, -0.13649700687936017, 0.5025492965657704, 0.32311961644551385, -0.3258929724694471, -0.4453898078305005, 0.1532967342661003, -0.1520921297104718, 0.4903157073776644, 0.02496210633505935, 0.22045881306836082, 0.07849957150302421, -0.4452514192126454, -0.01050764528158455, -0.390139839492732, -0.19445844720996047, 0.19960890541781037, -0.19154038176770444, 0.698348624736613, 0.06884953079674774, 0.31980553234202125, -0.17601748338111356, 0.12859082761462115, 0.2454635415885552, -0.15854076815725102, 0.45713239383844784, -0.4964217360084168, 0.15420282695732804, -0.33920270853773066, -0.4321453330246842, -0.22473845177959093, 0.6216059684229641, -0.1912994540139656, 0.39191726016849854, -0.14303673406465142, -0.09114944086069147, 0.14940474891145172, -0.02180010310835459, -0.11521840945369517, -0.170379860885253, -0.364441214038845, 0.10856191376435075, 0.07314587436566675, -0.157456705599001, -0.022642433955330644, -0.011077974752503704, 0.10303337382419012, -0.14543994204517974, 0.02397109674180617, -0.40097984936934317, 0.6990136023291924, 0.3307394000843496, 0.6219794656453255, -0.4554256060313668, -0.1357319162481911, -0.1686987783150187, 0.4890297399716927, -0.07534738401920374, 0.36982601647547886, 0.5570102703057985, -0.01611602731148116, -0.19623291128100379, 0.4295265600071441, 0.02098064489946467, -0.028332308622101572, 0.2543380101786935, -0.5405052546508025, 0.5790747921998975, -0.05496904772258531, -0.5672078451735216, 0.28100814433055504, -0.25062843480359104, 0.2813243407811661, 0.3448389629338883, -0.4619615214419051, -0.5456547154389294, 0.7767558568433034, -0.5036389030106092, -1.085850160722981, 0.3461295577437174, -0.9811480214350147, -0.7241808685760505, 0.013460703567328317, -0.8642755778337328, -1.2530470885812937, -0.7317199770203241, -0.46208495952162, 0.45788484760785275, 0.5417624638141079, -0.6452645482200772, 1.4988829536172825, -0.4946693257915242, 0.21862187029077432, -0.558967805880305, -0.011194224385067928, 0.28237193247181686, -0.03231133849458729, 0.4736530066909412, -0.0017957013405080287, -0.21877189113963158, 0.49244221633892327, 0.39805607068245635, 0.25680067952741603, 0.07945955218521161, -0.07814847590617567, 0.20171820666054527, 0.5090759527067074, -0.08269742663634931, -0.13802872858770934, 0.35991205015387895, -0.45966414554505786, 0.27822838090073326, 0.10770874632968336, 0.1387446723012204, 0.167652287189668, 0.3337833634256111, 0.001795014833771921, -0.2511016672236038, -0.3450684094599056, -0.05037167311022209, -0.4945936717423912, 0.45720369655657106, -0.2518957481131335, -0.54129973702979, -0.38552564827124836, -0.3914049917493398, 0.025650497856008564, 0.06976553929435034, 0.04576777546357963, 0.28327043726586126, 0.6787192463298694, -0.3643993832992538, -0.5440584620048586, -0.12057941209829008, -0.10882766789173769, 0.13065542210901276, -0.31270715526697923, -0.16649292031353444, -0.3599574174305693, -0.049057613659532553, -0.7369339378421143, -0.04847240558814303, 0.34266336879463644, -0.22143293216576637, -0.8677767212763864, -0.7584367477753152, 0.0641596157340054, 0.09266498480330525, 0.39165342985655954, -0.08407192411748751, 0.8082163270366246, -0.5665832941579195, 0.5142405412130724, -0.15432747209289427, -0.19769185191608807, -0.0011710881620144032, -0.13476166450836138, -0.3748941251895517, -0.10357676498404025, 0.3003683980258066, -0.27236486905887136, -0.2528355833353694, -0.2811593086577814, 0.010744631779067915, -0.07131898244026597, -0.1763253892736641, 0.27884381786083795, -0.12703936749106223, 0.34561607272864564, 0.18047139221874445, 0.37764605132704043, -0.20232109047376917, 0.19953629217258897, -0.3426395952701693, 0.5938819576512793, 0.6491142760410574, -0.4828353986746282, 0.3202275078997288, 0.19959349269380572, -0.14822878574816353, 0.3907884860951026, 0.3321289940058813, 0.05228769690974976, 0.47088666698823517, 0.12340022924249887, 0.6853311911007419, 0.5740441609034703, -0.01898687973318603, 0.11237177819210133, 0.00542895569252869, -0.18494603026804457, -0.3435830294469121, -0.1575594812697572, 0.24686500565582845, 0.06340867142081452, -0.09887066123172364, 0.07625770171532623, 0.19165986938849014, -0.5234127113431312, 0.08391400887149221, -0.06284831486319782, -0.24348845754063808, -0.2536905670324694, 0.042179179503979966, -0.19505353201950146, -0.32878674431085103, -0.39154766612187863, 0.11643928244860134, 0.2827245659821558, -0.322250882621964, 0.5321208906997132, 0.1809029491341471, -0.6569936567994179, -0.3169822546878345, 0.11054503010930143, 0.1516778907827172, -0.09435402768872693, -0.016082703376275334, 0.07788909267470676, -0.07580159941840099, 0.025389531291085378, 0.10570556551606583, 0.1394841382191563, 0.15371082677741013, -0.06471000958664408, 0.016084651279780208, 0.10032727426334652, -0.06573104379331861, 0.10890683555680868, 0.17004469557926052, -0.01851626785199155, -0.19337886106734717, 0.267480095740883, 0.0826784030732948, -1.2575054957885496, 0.8307178792263696, 0.7548795929267963, -0.7430329211388877, 0.6790075213880608, 1.2818736246430993, 0.5285557208807058, -0.3427366683238951, -0.31552250140266563, -0.10396252095219626, 0.39144450354816485, 0.7385276166070205, 0.6956799125791023, -0.028155288651385234, 0.8407765266458203, 0.441417009810756, -0.5283830103872068, -0.4998455859154361, 0.04057678477122209, -0.08329835009245791, 1.443333674020475, -0.033361747115838315, 0.47384199473450656, 0.7015860577857205, 0.69140020019837, 0.7139679925282796, 0.08453357538324979, 0.7663769793007198, 0.35347940580929066, 0.9288440510893102, -0.07926107496155169, -0.25375989697708384, 2.4673990947545037, 0.2504112724329049, -0.4914888582599686, 1.124195805028931, -0.9465022842421633, 0.46517845541076064, 1.8308021031010837, 0.0907578965026879, 0.1402636716166272, -1.0374236493363773, -0.5374626868393806, 0.6742361135859634, -1.2920562138995335, -0.5042593683747598, 0.21683735572741802, 0.3771828649637838, -0.3340305012966818, 0.024036897444315395, -2.3914810544629073, -0.029470923652774872, -0.8333800663546046, 1.1094993635558232, -0.6450475802666034, 0.1893169012431376, 0.1530443834672273, 0.7998331085823039, 0.4595703381696452, 0.6736796958243215, -0.050614028396243536, 0.2290426192479731, 0.06393831686646959, 2.4887736773473654, 1.9324334296345018, 3.5768594287017605, -0.6008860994249312, -0.05579843757157345, 0.3325217047847436], diffusion_p = [-0.5827252283190573, -0.029605145287175165, -0.13109246386119341, 1.8898209631644673, 0.9805855822444762, 0.7286208532620863, -0.4914502004544569, -0.456442184028581, -1.531934002737472, -0.7210878233946741, 0.371990054301104, 0.37239588841648186, -0.5413623333725835, 1.1514687166543187, -0.6438789043100039, 0.9042401893342684, 0.8936824774914186, -0.12728120551660962, 0.8244001309476007, 0.2764569269914579, 0.3458995093905973, 0.4137537867569561, -1.4664578073870043, -1.2044774236638518, -0.7066458166912352, -0.267815323627683, 0.38171925988024746, -0.29283275509980156, -0.5792473668657221, 1.148834050307798, 0.5861979141881614, 0.17216592516041537, -0.7989302050683911, -0.28855487242881467, -1.0142564560415848, -0.400478705118281, 0.009081051738873644, 0.9217098005823624, -0.8060451256284206], encoder_p = [0.4310796856880188, -0.1564745455980301, -0.2790025770664215, 0.32293665409088135, -0.029417384415864944, 0.10011578351259232, 0.08167217671871185, -0.4058156907558441, 0.02978740818798542, 0.21646593511104584, 0.1837470531463623, -0.03039354644715786, 0.3631804883480072, -0.2597687542438507, -0.2881057560443878, 0.18328341841697693, 0.29528307914733887, 0.19500553607940674, -0.4282739758491516, 0.3501529395580292, 0.44827860593795776, 0.09499610960483551, -0.4011346101760864, -0.12588103115558624, -0.3064194917678833, 0.08380003273487091, 0.007921045646071434, -0.3221067190170288, 0.06708426773548126, 0.0019201388349756598, -0.10411644726991653, 0.09676839411258698, 0.26943492889404297, 0.34509947896003723, -0.12942413985729218, 0.18618255853652954, -0.012280049733817577, 0.3132334053516388, -0.11702664196491241, -0.11059870570898056, -0.0851144939661026, -0.26091107726097107, 0.4146385192871094, 0.3800686001777649, -0.2389996200799942, -0.038073521107435226, -0.052187610417604446, -0.3998015224933624, 0.35727426409721375, -0.009910650551319122, 0.18730227649211884, -0.3871683180332184, -0.08313389867544174, 0.05513373762369156, 0.2703809440135956, -0.34749239683151245, -0.07002026587724686, 0.08322234451770782, -0.257688045501709, -0.015458991751074791, 0.42598965764045715, 0.40707290172576904, 0.15762129426002502, 0.26828327775001526, 0.041621435433626175, 0.1812635213136673, 0.05806030333042145, 0.3847128748893738, 0.10490471869707108, -0.2885902523994446, 0.40761274099349976, 0.3032993674278259, -0.4085453748703003, 0.12999217212200165, -0.15482214093208313, -0.20328298211097717, -0.1853734403848648, 0.005667226854711771, -0.03495146334171295, 0.10366681218147278, -0.3984021842479706, 0.24918104708194733, -0.02783063054084778, -0.33549049496650696, -0.3748747706413269, 0.10323962569236755, 0.12114425003528595, 0.14849166572093964, -0.20721681416034698, 0.4245603084564209, -0.15306806564331055, -0.167749285697937, 0.07884591072797775, 0.08585900068283081, 0.16113534569740295, 0.06572934240102768, -0.25546759366989136, 0.3829953670501709, 0.13171207904815674, -0.03063521534204483, -0.3868297338485718, 0.2072511464357376, -0.2160273790359497, -0.12530647218227386, -0.03495141118764877, 0.3470931053161621, -0.39909103512763977, -0.03483284264802933, 0.2844665050506592, -0.39764198660850525, 0.35323581099510193, -0.30750134587287903, 0.09179406613111496, -0.1895224004983902, -0.2960474193096161, -0.032901402562856674, -0.3796003758907318, -0.13819919526576996, -0.1515687257051468, 0.23338629305362701, 0.3824295103549957, -0.3930381238460541, 0.41503477096557617, 0.05630825459957123, -0.006062322296202183, -0.36605602502822876, -0.06479857116937637, -0.24803899228572845, -0.17148204147815704, -0.43837329745292664, -0.16066983342170715, -0.33772212266921997, -0.0980897918343544, 0.06756631284952164, 0.32119518518447876, 0.01199754886329174, -0.2559008002281189, 0.4311824142932892, 0.3628380000591278, 0.14328445494174957, 0.22363926470279694, 0.14999601244926453, -0.06631326675415039, -0.06383708864450455, 0.2924171984195709, -0.264708548784256, -0.16897381842136383, 0.1323089599609375, 0.29843148589134216, 0.40776658058166504, -0.190637469291687, 0.09345665574073792, 0.35584574937820435, 0.1761167198419571, 0.10512398928403854, -0.016766894608736038, -0.19568073749542236, -0.4078931510448456, -0.2464423030614853, 0.21671371161937714, 0.37406331300735474, 0.27171042561531067, 0.24236686527729034, 0.19766773283481598, -0.2314554899930954, -0.33643126487731934, -0.28005450963974, -0.14334720373153687, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.2554247975349426, -0.7549784183502197, 0.4911440312862396, 0.5954092144966125, -0.5272296667098999, 0.4999324083328247, -0.6739473938941956, -0.7647075653076172, 0.05286497622728348, 0.6352071762084961, 0.5419179201126099, -0.24170181155204773, -0.7065765261650085, 0.5737209916114807, 0.45186805725097656, -0.22098912298679352, 0.7260597348213196, 0.36472105979919434, -0.16796883940696716, 0.0755566731095314, 0.1372394859790802, -0.21521496772766113, -0.6893054246902466, 0.07744879275560379, 0.0, 0.0, 0.0, 0.0], projector_p = [0.48884784374131446, 0.17588869516141056, -0.555756516080055, 0.4943258414488855])

# ╔═╡ 9ea12ddb-ff8a-4c16-b2a5-8b7603f262a3
md"""
Integrate the prior SDE in latent space to see what a run looks like:
"""

# ╔═╡ 9346f569-d5f9-43cd-9302-1ee64ef9a030
plot(NeuralSDEExploration.sample_prior(latent_sde, ps, b=5))

# ╔═╡ b98200a8-bf73-42a2-a357-af56812d01c3
md"""
Integrate the posterior SDE in latent space given context:
"""

# ╔═╡ 26885b24-df80-4fbf-9824-e175688f1322
@bind seed Slider(1:1000)

# ╔═╡ 5f56cc7c-861e-41a4-b783-848623b94bf9
@bind ti Slider(1:length(timeseries))

# ╔═╡ 88fa1b08-f0d4-4fcf-89c2-8a9f33710d4c
posterior_latent, posterior_data, logterm_, kl_divergence_, distance_ = NeuralSDEExploration.pass(latent_sde, ps, timeseries[ti:ti+4]; seed=seed)

# ╔═╡ f4f2c0ac-06f3-4632-b314-aa6e91bc84db
plot(timeseries[ti:ti+2])

# ╔═╡ dabf2a1f-ec78-4942-973f-4dbf9037ee7b
plot(logterm_[1, :, :]', label="KL-Divergence")

# ╔═╡ 38324c42-e5c7-4b59-8129-0e4c17ab5bf1
plot(posterior_data[1, :, :]', label="posterior")

# ╔═╡ 08021ed6-ac31-4829-9f21-f046af73d5a3
plot(posterior_latent[:, 1, :]')

# ╔═╡ 92c138d3-05f6-4a57-9b6b-08f41cb4ea55
plot(NeuralSDEExploration.sample_posterior(latent_sde, ps, timeseries[1:1], seed=seed+1))

# ╔═╡ 18acf95a-4fa2-452d-875d-01dfc7f18bac
plot(NeuralSDEExploration.pass(latent_sde,  ps, timeseries[2:2], seed=seed+3)[1][:, 1, :]')

# ╔═╡ 3d889727-ae6d-4fa0-98ae-d3ae73fb6a3c
plot(NeuralSDEExploration.sample_prior(latent_sde, ps, seed=seed))

# ╔═╡ b5c6d43c-8252-4602-8232-b3d1b0bcee33
function cb()
	posteriors = []
	priors = []
	posterior_latent = nothing
	datas = []
	n = 5
	rng = Xoshiro(1230)
	nums = sample(rng,1:length(timeseries),n;replace=false)

	posterior_latent, posterior_data, logterm_, kl_divergence_, distance_ = NeuralSDEExploration.pass(latent_sde, ps, timeseries[nums], seed=seed+i)
	
	priorsamples = 20
	prior_latent = NeuralSDEExploration.sample_prior(latent_sde,ps,seed=seed+i;b=priorsamples)
	projected_prior = vcat([latent_sde.projector_re(ps.projector_p)(x) for x in prior_latent.u]...)

	posteriorplot = plot(posterior_data[1, :,:]',linewidth=2,legend=false,title="projected posterior")
	dataplot = plot(timeseries[nums],linewidth=2,legend=false,title="data")
	priorplot = plot(projected_prior, linewidth=.5,color=:grey,legend=false,title="projected prior")
	
	timeseriesplot = plot(sample(rng, timeseries, priorsamples),linewidth=.5,color=:grey,legend=false,title="data")
	
	l = @layout [a b ; c d]
	p = plot(dataplot, posteriorplot, timeseriesplot, priorplot, layout=l)
	#p = plot(timeseriesplot)
	#posterior_latent
	p
end

# ╔═╡ 025b33d9-7473-4a54-a3f1-787a8650f9e7
begin
	p=cb()
	savefig(p, "/home/linushe/plot.pdf")
end


# ╔═╡ f0a34be1-6aa2-4563-abc2-ea163a778752
function loss(ps, minibatch)
	mean(NeuralSDEExploration.loss(latent_sde, ps, minibatch, 0.1))
end

# ╔═╡ ef59f249-64c5-4262-b987-327d67b70422
loss(ps, timeseries[sample(1:size(timeseries)[1], 5, replace=false)])

# ╔═╡ f4a16e34-669e-4c93-bd83-e3622a747a3a
function train(learning_rate, num_steps)
	
	ar = 20 # annealing rate
	sched = Loop(Sequence([Loop(x -> (50*x)/ar, ar), Loop(x -> 50.0, ar)], [ar, ar]), ar*2)

	
	opt_state = Optimisers.setup(Optimisers.Adam(), ps)
	anim = @animate for (step, eta) in zip(1:num_steps, sched)
		minibatch = timeseries[sample(1:size(timeseries)[1], 5, replace=false)]
		if step % 10 == 1
			cb()
		end
		
		l = loss(ps, minibatch)
		println("Loss: $l")
		dps = similar(ps)
		#Enzyme.autodiff(Reverse, loss, Const, Duplicated(ps, dps))
		
		#return Vector(grads)
		dps = Zygote.gradient(ps -> loss(ps, minibatch), ps)[1]

		Optimisers.update!(opt_state, ps, dps)
	end
	return gif(anim)
end

# ╔═╡ 2ada3ddd-b47a-46ff-abba-17cbb94041a2
md"Enable training $(@bind enabletraining CheckBox())"

# ╔═╡ 5a17f6c0-ead1-448f-8df8-60e68a96e0db
begin
	if enabletraining
		train(0.1, 1)
	end
end

# ╔═╡ a528a99c-5f9e-4d04-abd2-6b9264fb775d
begin
	if enabletraining
		train(0.1, 500)
	end
end

# ╔═╡ 0fc3eae9-467a-4305-b126-327bb3d7892c
begin
	if enabletraining
		train(0.1, 500)
	end
end

# ╔═╡ 099466a0-f47d-4aca-9520-63fdc2915332
begin
	if enabletraining
		train(0.1, 500)
	end
end

# ╔═╡ 0eaadc9e-e4c9-49cc-a65e-8fd805eacaa1
begin
	if enabletraining
		train(0.1, 500)
	end
end

# ╔═╡ 3e9dc0b1-aff1-4b5f-a78c-d42269b247e8
begin
	if enabletraining
		train(0.1, 500)
	end
end

# ╔═╡ a5ccef36-cd09-4403-bed2-4aa406039ebb
begin
	if enabletraining
		train(0.1, 500)
	end
end

# ╔═╡ 95e10df6-c448-4dae-b400-b6dcfeaf7438
begin
	if enabletraining
		train(0.1, 500)
	end
end

# ╔═╡ ccaa1092-915b-4b14-b0e2-eae663cb5b92
begin
	if enabletraining
		train(0.1, 500)
	end
end

# ╔═╡ 4d728103-4753-40f6-ab8a-29261d6813e9
begin
	if enabletraining
		train(0.1, 500)
	end
end

# ╔═╡ 2d7a69b7-ee51-4fbf-8ce1-40ce3fff751e
begin
	if enabletraining
		train(0.05, 500)
	end
end

# ╔═╡ 794b30ff-f409-4c2e-923f-789353306cda
begin
	if enabletraining
		train(0.05, 500)
	end
end

# ╔═╡ f3f493de-256b-4cd9-ab16-db88b45df937
begin
	if enabletraining
		train(0.05, 500)
	end
end

# ╔═╡ ea8190e8-2147-4846-92f3-531796efacdd
begin
	if enabletraining
		train(0.05, 500)
	end
end

# ╔═╡ 78fafa9b-8fcb-455f-ba8d-fee5e511cda5
begin
	if enabletraining
		train(0.05, 500)
	end
end

# ╔═╡ 8773bfa2-fd50-4409-be0b-d550b0686e8a
begin
	if enabletraining
		train(0.05, 500)
	end
end

# ╔═╡ 322b71cc-7499-4384-9962-25f54c0d3572
begin
	if enabletraining
		train(0.05, 500)
	end
end

# ╔═╡ f4159b1c-0b3e-418e-9486-d3584da4dd29
begin
	if enabletraining
		train(0.05, 500)
	end
end

# ╔═╡ 73b1b46f-2101-4da3-934a-ea8710a52cb4
begin
	if enabletraining
		train(0.05, 500)
	end
end

# ╔═╡ 810228ad-fe76-47a9-b54c-c1afd8de9e2a
begin
	if enabletraining
		train(0.05, 500)
	end
end

# ╔═╡ b24aef95-9e67-42b2-b83e-295ca5e967d9
begin
	if enabletraining
		train(0.035, 100)
	end
end

# ╔═╡ d18ea71c-efb9-4e7f-abff-a2f81d77b883
begin
	if enabletraining
		train(0.035, 100)
	end
end

# ╔═╡ c2dedddf-6ba1-43af-b446-828b392efb36
begin
	if enabletraining
		train(0.035, 1000)
	end
end

# ╔═╡ 216734d2-92e7-459d-baa0-74b4f86dfd1a
begin
	if enabletraining
		train(1f-3, 100)
	end
end

# ╔═╡ 37c22306-ee80-4625-85e2-ff4093375343
begin
	if enabletraining
		train(1f-3, 1000)
	end
end

# ╔═╡ 2961c8fb-83de-4081-b78e-17405e4ec2fc
begin
	if enabletraining
		train(1f-3, 1000)
	end
end

# ╔═╡ 2d6c7a30-56e7-4a19-a910-37adc97be19e
begin
	if enabletraining
		train(1f-3, 1000)
	end
end

# ╔═╡ d3fd0a5d-2637-48db-94c1-623f6cae9033
begin
	if enabletraining
		train(1f-3, 1000)
	end
end

# ╔═╡ 7ce64e25-e5a5-4ace-ba6b-844ef6e4ef82
show(IOContext(stdout, :limit=>false), MIME"text/plain"(), ps)

# ╔═╡ Cell order:
# ╠═67cb574d-7bd6-40d9-9dc3-d57f4226cc83
# ╠═db557c9a-24d6-4008-8225-4b8867ee93db
# ╠═b6abba94-db07-4095-98c9-443e31832e7d
# ╠═d1440209-78f7-4a9a-9101-a06ad2534e5d
# ╟─32be3e35-a529-4d16-8ba0-ec4e223ae401
# ╠═f74dd752-485b-4203-9d72-c56e55a3ef76
# ╟─cc2418c2-c355-4291-b5d7-d9019787834f
# ╠═dd03f851-2e26-4850-a7d4-a64f154d2872
# ╠═c00a97bf-5e10-4168-8d58-f4f9270258ac
# ╟─1502612c-1489-4abf-8a8b-5b2d03a68cb1
# ╠═455263ef-2f94-4f3e-8401-f0da7fb3e493
# ╟─f4651b27-135e-45f1-8647-64ab08c2e8e8
# ╠═aff1c9d9-b29b-4b2c-b3f1-1e06a9370f64
# ╠═9a5c942f-9e2d-4c6c-9cb1-b0dffd8050a0
# ╟─da11fb69-a8a1-456d-9ce7-63180ef27a83
# ╠═22453ba0-81a7-43f6-bb80-91d3c991530d
# ╠═d81ccb5f-de1c-4a01-93ce-3e7302caedc0
# ╠═b5721107-7cf5-4da3-b22a-552e3d56bcfa
# ╠═9767a8ea-bdda-43fc-b636-8681d150d29f
# ╟─39154e76-01f7-4710-8f21-6f3a7d3fcfcd
# ╠═847587ec-9297-471e-b788-7b776c05851e
# ╠═95f42c13-4a06-487c-bd35-a8d6bac9e02e
# ╠═63632673-4374-450c-a48d-493ae7a6b1ce
# ╠═016ab596-424b-4c50-b5c0-46d08aa47909
# ╠═bdf4c32c-9a2b-4814-8513-c6e16ebee69c
# ╟─0d09a662-78d3-4202-b2be-843a0669fc9f
# ╠═cdebb87f-9759-4e6b-a00a-d764b3c7fbf8
# ╠═3ec28482-2d6c-4125-8d85-4fb46b130677
# ╟─8b283d5e-1ce7-4deb-b382-6fa8e5612ef1
# ╠═c14806bd-42cf-480b-b618-bfe72183feb3
# ╟─64dc2da0-48cc-4242-bb17-449a300688c7
# ╠═df2034fd-560d-4529-836a-13745f976c1f
# ╟─4a97576c-96de-458e-b881-3f5dd140fa6a
# ╠═a1cb11fb-ec69-4ba2-9ed1-2d1a6d24ccd9
# ╟─bfabcd80-fb62-410f-8710-f577852c77df
# ╠═f0486891-b8b3-4a39-91df-1389d6f799e1
# ╠═001c318e-b7a6-48a5-bfd5-6dd0368873ac
# ╠═05568880-f931-4394-b31e-922850203721
# ╠═5b073f11-08bd-4128-85c6-7f043b60bdb8
# ╠═bd8fbd96-d945-4ba0-a389-d75d382438c5
# ╟─9ea12ddb-ff8a-4c16-b2a5-8b7603f262a3
# ╠═9346f569-d5f9-43cd-9302-1ee64ef9a030
# ╟─b98200a8-bf73-42a2-a357-af56812d01c3
# ╠═26885b24-df80-4fbf-9824-e175688f1322
# ╠═5f56cc7c-861e-41a4-b783-848623b94bf9
# ╠═88fa1b08-f0d4-4fcf-89c2-8a9f33710d4c
# ╠═f4f2c0ac-06f3-4632-b314-aa6e91bc84db
# ╠═dabf2a1f-ec78-4942-973f-4dbf9037ee7b
# ╠═38324c42-e5c7-4b59-8129-0e4c17ab5bf1
# ╠═08021ed6-ac31-4829-9f21-f046af73d5a3
# ╠═92c138d3-05f6-4a57-9b6b-08f41cb4ea55
# ╠═18acf95a-4fa2-452d-875d-01dfc7f18bac
# ╠═3d889727-ae6d-4fa0-98ae-d3ae73fb6a3c
# ╠═b5c6d43c-8252-4602-8232-b3d1b0bcee33
# ╠═025b33d9-7473-4a54-a3f1-787a8650f9e7
# ╠═f0a34be1-6aa2-4563-abc2-ea163a778752
# ╠═ef59f249-64c5-4262-b987-327d67b70422
# ╠═f4a16e34-669e-4c93-bd83-e3622a747a3a
# ╟─2ada3ddd-b47a-46ff-abba-17cbb94041a2
# ╠═5a17f6c0-ead1-448f-8df8-60e68a96e0db
# ╠═a528a99c-5f9e-4d04-abd2-6b9264fb775d
# ╠═0fc3eae9-467a-4305-b126-327bb3d7892c
# ╠═099466a0-f47d-4aca-9520-63fdc2915332
# ╠═0eaadc9e-e4c9-49cc-a65e-8fd805eacaa1
# ╠═3e9dc0b1-aff1-4b5f-a78c-d42269b247e8
# ╠═a5ccef36-cd09-4403-bed2-4aa406039ebb
# ╠═95e10df6-c448-4dae-b400-b6dcfeaf7438
# ╠═ccaa1092-915b-4b14-b0e2-eae663cb5b92
# ╠═4d728103-4753-40f6-ab8a-29261d6813e9
# ╠═2d7a69b7-ee51-4fbf-8ce1-40ce3fff751e
# ╠═794b30ff-f409-4c2e-923f-789353306cda
# ╠═f3f493de-256b-4cd9-ab16-db88b45df937
# ╠═ea8190e8-2147-4846-92f3-531796efacdd
# ╠═78fafa9b-8fcb-455f-ba8d-fee5e511cda5
# ╠═8773bfa2-fd50-4409-be0b-d550b0686e8a
# ╠═322b71cc-7499-4384-9962-25f54c0d3572
# ╠═f4159b1c-0b3e-418e-9486-d3584da4dd29
# ╠═73b1b46f-2101-4da3-934a-ea8710a52cb4
# ╠═810228ad-fe76-47a9-b54c-c1afd8de9e2a
# ╠═b24aef95-9e67-42b2-b83e-295ca5e967d9
# ╠═d18ea71c-efb9-4e7f-abff-a2f81d77b883
# ╠═c2dedddf-6ba1-43af-b446-828b392efb36
# ╠═216734d2-92e7-459d-baa0-74b4f86dfd1a
# ╠═37c22306-ee80-4625-85e2-ff4093375343
# ╠═2961c8fb-83de-4081-b78e-17405e4ec2fc
# ╠═2d6c7a30-56e7-4a19-a910-37adc97be19e
# ╠═d3fd0a5d-2637-48db-94c1-623f6cae9033
# ╠═7ce64e25-e5a5-4ace-ba6b-844ef6e4ef82
