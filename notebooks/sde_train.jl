### A Pluto.jl notebook ###
# v0.19.22

using Markdown
using InteractiveUtils

# This Pluto notebook uses @bind for interactivity. When running this notebook outside of Pluto, the following 'mock version' of @bind gives bound variables a default value (instead of an error).
macro bind(def, element)
    quote
        local iv = try Base.loaded_modules[Base.PkgId(Base.UUID("6e696c72-6542-2067-7265-42206c756150"), "AbstractPlutoDingetjes")].Bonds.initial_value catch; b -> missing; end
        local el = $(esc(element))
        global $(esc(def)) = Core.applicable(Base.get, el) ? Base.get(el) : iv(el)
        el
    end
end

# ╔═╡ 67cb574d-7bd6-40d9-9dc3-d57f4226cc83
begin
	import Pkg
	Pkg.activate("..")
	using Revise
end

# ╔═╡ b6abba94-db07-4095-98c9-443e31832e7d
using Optimisers, StatsBase, Zygote, ForwardDiff, Enzyme, Flux, DifferentialEquations, Functors, ComponentArrays, Distributions, ParameterSchedulers, Random

# ╔═╡ d1440209-78f7-4a9a-9101-a06ad2534e5d
using NeuralSDEExploration, Plots, PlutoUI, ProfileSVG

# ╔═╡ db557c9a-24d6-4008-8225-4b8867ee93db
Revise.retry()

# ╔═╡ 32be3e35-a529-4d16-8ba0-ec4e223ae401
md"""
Let's train a Neural SDE from a modified form of the simple zero-dimensional energy balance model. First, let's just instantiate the predefined model from the package...
"""

# ╔═╡ f74dd752-485b-4203-9d72-c56e55a3ef76
ebm = NeuralSDEExploration.ZeroDEnergyBalanceModel(0.425, 0.4, 1363, 0.6 * 5.67e-8, 0.14)

# ╔═╡ cc2418c2-c355-4291-b5d7-d9019787834f
md"Let's generate the data and plot a quick example:"

# ╔═╡ dd03f851-2e26-4850-a7d4-a64f154d2872
begin
	n = 1000
    datasize = 200
    tspan = (0.0f0, 10f0)
end

# ╔═╡ c00a97bf-5e10-4168-8d58-f4f9270258ac
solution = NeuralSDEExploration.series(ebm, shuffle(range(210.0f0, 320.0f0, n)), tspan, datasize)

# ╔═╡ 1502612c-1489-4abf-8a8b-5b2d03a68cb1
md"""
Let's also plot some example trajectories:
"""

# ╔═╡ 455263ef-2f94-4f3e-8401-f0da7fb3e493
plot(reduce(hcat, [solution[i].u for i in 1:10]))

# ╔═╡ f4651b27-135e-45f1-8647-64ab08c2e8e8
md"""
Let's normalize our data for training:
"""

# ╔═╡ aff1c9d9-b29b-4b2c-b3f1-1e06a9370f64
begin
    datamax = max([max(x.u...) for x in solution]...)
    datamin = min([min(x.u...) for x in solution]...)

    function normalize(x)
        return ((x - datamin) / (datamax - datamin))
    end

    function rescale(x)
        return ((datamax - datamin)) + datamin
    end
end

# ╔═╡ 9a5c942f-9e2d-4c6c-9cb1-b0dffd8050a0
timeseries = [(t=ts.t, u=map(normalize, ts.u)) for ts in solution]

# ╔═╡ da11fb69-a8a1-456d-9ce7-63180ef27a83
md"""
We are going to build a simple latent SDE. Define a few constants...
"""

# ╔═╡ 22453ba0-81a7-43f6-bb80-91d3c991530d
context_size = 4 # The size of the context given to the posterior SDE.

# ╔═╡ d81ccb5f-de1c-4a01-93ce-3e7302caedc0
hidden_size = 20 # The hidden layer size for all ANNs.

# ╔═╡ b5721107-7cf5-4da3-b22a-552e3d56bcfa
latent_dims = 3 # Dimensions of the latent space.

# ╔═╡ 9767a8ea-bdda-43fc-b636-8681d150d29f
data_dims = 1 # Dimensions of our input data.

# ╔═╡ 39154e76-01f7-4710-8f21-6f3a7d3fcfcd
md"""
The encoder takes a timeseries and outputs context that can be passed to the posterior SDE, that is, the SDE that has information about the data and encodes $p_\theta(z \mid x)$.
"""

# ╔═╡ 847587ec-9297-471e-b788-7b776c05851e
encoder = Flux.Chain(Flux.LSTM(data_dims => 6), Flux.Dense(6 => context_size)) |> f64

# ╔═╡ 95f42c13-4a06-487c-bd35-a8d6bac9e02e
@bind i Slider(1:length(timeseries))

# ╔═╡ 63632673-4374-450c-a48d-493ae7a6b1ce
begin
	Flux.reset!(encoder)
	example_context = encoder(reshape(timeseries[i].u, 1, 1, :))[:, 1, :]
end

# ╔═╡ 016ab596-424b-4c50-b5c0-46d08aa47909
plot(example_context')

# ╔═╡ bdf4c32c-9a2b-4814-8513-c6e16ebee69c
plot(timeseries[i].u, legend=nothing)

# ╔═╡ 0d09a662-78d3-4202-b2be-843a0669fc9f
md"""
The `initial_posterior` net is the posterior for the initial state. It takes the context and outputs a mean and standard devation for the position zero of the posterior. The `initial_prior` is a fixed gaussian distribution.
"""

# ╔═╡ cdebb87f-9759-4e6b-a00a-d764b3c7fbf8
initial_posterior = Flux.Dense(context_size => latent_dims + latent_dims) |> f64

# ╔═╡ 3ec28482-2d6c-4125-8d85-4fb46b130677
initial_prior = Flux.Dense(1 => latent_dims + latent_dims, init=Flux.glorot_uniform) |> f64

# ╔═╡ 8b283d5e-1ce7-4deb-b382-6fa8e5612ef1
md"""
Drift of prior. This is just an SDE drift in the latent space
"""

# ╔═╡ c14806bd-42cf-480b-b618-bfe72183feb3
drift_prior = Flux.Chain(
	Flux.Dense(latent_dims => hidden_size, tanh),
	Flux.Dense(hidden_size => hidden_size, tanh),
	Flux.Dense(hidden_size => hidden_size, tanh),
	Flux.Dense(hidden_size => latent_dims, tanh),
	Flux.Scale(latent_dims)
) |> f64

# ╔═╡ 64dc2da0-48cc-4242-bb17-449a300688c7
md"""
Drift of posterior. This is the term of an SDE when fed with the context.
"""

# ╔═╡ df2034fd-560d-4529-836a-13745f976c1f
drift_posterior = Flux.Chain(
	Flux.Dense(latent_dims + context_size => hidden_size, tanh),
	Flux.Dense(hidden_size => hidden_size, tanh),
	Flux.Dense(hidden_size => latent_dims, tanh),
	Flux.Scale(latent_dims)
) |> f64

# ╔═╡ 4a97576c-96de-458e-b881-3f5dd140fa6a
md"""
Diffusion. Prior and posterior share the same diffusion (they are not actually evaluated seperately while training, only their KL divergence). This is a diagonal diffusion, i.e. every term in the latent space has its own independent Wiener process.
"""

# ╔═╡ a1cb11fb-ec69-4ba2-9ed1-2d1a6d24ccd9
diffusion = [Flux.Chain(Flux.Dense(1 => 4, softplus), Flux.Dense(4 => 1, sigmoid)) |> f64 for i in 1:latent_dims]

# ╔═╡ bfabcd80-fb62-410f-8710-f577852c77df
md"""
The projector will transform the latent space back into data space.
"""

# ╔═╡ f0486891-b8b3-4a39-91df-1389d6f799e1
projector = Flux.Dense(latent_dims => data_dims) |> f64

# ╔═╡ 001c318e-b7a6-48a5-bfd5-6dd0368873ac
latent_sde = LatentSDE(
	initial_prior,
	initial_posterior,
	drift_prior,
	drift_posterior,
	diffusion,
	encoder,
	projector,
    tspan,
	EulerHeun();
	saveat=range(tspan[1], tspan[end], datasize),
	dt=(tspan[end]/datasize)
)

# ╔═╡ 05568880-f931-4394-b31e-922850203721
ps_, re = Functors.functor(latent_sde)

# ╔═╡ 5b073f11-08bd-4128-85c6-7f043b60bdb8
# ╠═╡ disabled = true
#=╠═╡
ps = ComponentArray(ps_)
  ╠═╡ =#

# ╔═╡ bd8fbd96-d945-4ba0-a389-d75d382438c5
ps =ComponentVector{Float64}(initial_prior_p = [0.22783160563265417, -0.42047205320673975, 0.4017548873678343, 0.4189001975267388, -0.31819978806257876, -0.3763396008324492, -0.24212389830792894, 0.45686665424031353, -0.3508859560235847, -0.3600084128171941, 0.3739770903897227, 0.46333052083732174], initial_posterior_p = [-0.7209120392799377, -0.060817498713731766, -0.4154626131057739, 0.21080227196216583, 0.5869414210319519, -0.6983190178871155, -0.36968937516212463, -0.6831527948379517, -0.5928301811218262, -0.3418050706386566, -0.4378199279308319, 0.24985766410827637, -0.5649783611297607, 0.35832998156547546, -0.7011997699737549, -0.02677474357187748, -0.027573755010962486, -0.5726481676101685, 0.42148590087890625, -0.7033055424690247, 0.6333048343658447, -0.35436883568763733, 0.03166317567229271, 0.004290352575480938, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], drift_prior_p = [-0.546852304780376, -0.3217357459781851, 0.27517347857179997, 0.08898543985034818, 0.2566860069376788, 0.06012141991696558, 0.12122660125091868, -0.12078407501143304, 0.5480068352120505, 0.39821384035339086, -0.131610529439143, -0.7389353595723108, 0.3401896433344529, -0.3200039298414055, -0.29714990422912935, -0.3556910316868809, 0.11609804372320638, 0.03738504605341362, 0.14820658514006774, 0.44986899745678066, -0.5573354238550032, 0.4758141774601743, -0.18977404213890223, -0.5405220724794982, -0.4680622791072537, 0.009801267313220759, 0.21405236743462588, -0.035853625418722446, 0.08376707083042781, -0.35399937968496337, -0.35454782599676404, -0.3116888129240722, -0.5249758562995996, -0.11490364388412087, 0.3149055228569725, -0.44754474435740615, -0.41795050463637995, 0.3343441019328464, -0.14317856169452625, -0.012136539444315126, -0.29342837756523016, -0.39117459047574615, -0.3327957172094216, 0.3938346723704881, -0.26894513110846857, -0.24863642619055076, -0.005985466696442079, -0.10887809911509228, -0.41213619031077503, -1.1350582484387304, -0.061987452755293194, -0.6379788466005388, 0.1575037604755913, 0.22990188516073026, -0.459424479731331, -0.6434845681300168, 0.17748465878644776, -0.40422675578145983, -0.38222644629759644, -0.382044657889397, 0.018541157798038204, -0.032191979724027146, 0.10008127393434581, 0.35679215405834125, 0.08273941317836801, -0.10818662198274183, -0.12949135846906792, -0.05586059532205176, 0.1130670456204979, 0.24189311631513563, -0.07263859027096196, -0.06012118401384239, 0.15448804424316617, -0.21838099147391, 0.14946759822360953, 0.09022515120739666, 0.05656020655463391, -0.3610344590582155, -0.03921847007450666, -0.2208738797854933, 0.15489303731902976, -0.044832853673016065, 0.3251248159723005, 0.23500486169795606, -0.19673279432100121, -0.1718184285542359, 0.16781405682332745, -0.18061520753240137, 0.1534542061464842, 0.3036215074204034, 0.12226206377417875, -0.18671231539433872, -0.036424901037160395, 0.2542105461556508, 0.37426896683094923, 0.21027446469875818, -0.022982860014139, -0.2699971229531741, 0.2748451762769623, -0.13642410708357722, -0.46359582364306473, -0.3137834925055357, 0.04933941514722447, -0.1794131839507185, -0.10964470512333596, 0.26933768034169603, -0.13273126394883625, 0.23308002628921384, 0.052882596153586744, -0.18314011886049425, -0.23584961318978878, -0.30898268017633185, -0.20790233764606247, 0.026231886300985236, -0.21254481062734232, -0.2504374295000269, 0.04444860854193739, -0.10766599067143312, 0.29401650348152375, 0.06077306197757236, 0.28103270947033127, -0.27518969196503656, -0.33237362134652737, -0.23097529855885227, 0.3208892230207735, 0.3460600720003905, 0.2412160518915788, 0.09203827113659442, -0.18514922258364072, -0.41430941814081373, -0.6087901517321579, 0.5362822524148049, 0.05677682326183041, 0.4273343465148375, -0.21465371131410768, 0.3919202325396416, -0.1728009758065057, 0.3856943664254405, 0.479471908468517, 0.4567087125542277, 0.3753185861972226, 0.02874730869024162, 0.34343333923405317, 0.17572230093753918, -0.378361816709583, 0.09911831144579743, -0.6587552518988187, -0.08759681985958637, 0.3007035749725445, -0.1990924749240993, 0.0606339000159513, 0.12323335452790837, 0.10008735931362285, -0.16692812342163607, -0.23751458470056092, 0.17470950644662184, -0.14178626131561037, -0.07074040678485344, 0.08795574794844228, -0.03447533112177149, -0.20569337632077414, 0.009112091608855236, -0.19544220595020917, 0.4225050255177759, -0.15673786587154537, 0.0948259869413137, -0.1342238667641732, -0.4654006227566848, 0.20164677004993325, -0.3078210097321347, -0.25390384562576895, 0.2661987534473463, -0.26539179816640035, 0.430880048944997, 0.1426861523748805, -0.14336362094222574, 0.1778149233095163, 0.005962461944138403, 0.20451457685133337, 0.4922936142485874, 0.15287478206689245, 0.41172951679981606, -0.3206657120023659, 0.1980737844056889, -0.09852870696387638, 0.12686360452398698, -0.1530898407205942, 0.22446914716592642, -0.11802220732016788, -0.39541458031034976, -0.16567556318868742, 0.20352581592075383, 0.07771943755998834, -0.031983850620315224, -0.2655528947513044, 0.40424912769052457, -0.09857619494573848, -0.26020043377497104, 0.6109763857085115, -0.0687397093944744, 0.17236409033309688, 0.06216227141555323, -0.48448537383067347, -0.3389406857275811, -0.4020274399222102, -0.24839117426725388, 0.07662430181995679, 0.30260443525962083, 0.224376009686708, 0.20443731241774096, 0.2526134393153399, -0.4186166955125449, 0.20420771888826603, -0.6397708483789171, 0.20595998295333107, -0.04493224898398395, 0.2939014615263287, -0.014917850794098225, -0.01696835679246729, -0.01551314868920525, -0.1530171544231232, 0.2373066297670355, -0.13067740539630607, -0.21663454443632962, 0.40577710577340736, -0.11620008748863776, 0.006340010878827349, 0.18585201996927303, 0.13286521234452775, -0.6016508011021874, 0.0874446656297466, 0.1815743786873957, -0.23669219626941373, -0.19904110057479005, -0.1869682461229089, 0.4109480249764574, 0.06415996481815817, -0.6490854354360241, 0.07366767975709641, 0.09132620300583168, 0.22390331137809735, -0.28911942695143084, -0.038503237075615905, -0.3645965543563462, -0.14705301999862902, 0.4286793421351488, 0.42821925684704765, -0.3789948586382334, 0.5850122239930249, 0.07206788042382216, -0.43281260788678805, 0.2598265916329566, -0.2127214582431033, 0.19687039608551768, 0.2547118551423694, 0.27091347679960687, 0.5880467227928435, 0.19955268600895257, 0.28828386536292055, -0.008446071708896613, 0.047167494741862354, -0.04142713886824813, -0.25568099252059595, 0.24016232165161114, -0.002462968583500267, 0.3516636817036766, 0.0818811645269967, -0.094978472996529, 0.044858492651680515, -0.21189853125842456, 0.1928465048596011, -0.3626710071861233, 0.05160732544976341, -0.24762261051262674, 0.1814644117494566, -0.2942748945252913, 0.14089390706307936, 0.4782173739752451, 0.5570793102313683, -0.12631225706792223, -0.1269195302400202, -0.14147692491758385, -0.3832117270726735, -0.33561634332748413, 0.21960157062480906, -0.21737518290995128, -0.42691813431981535, -0.054054862298355356, 0.2560159306473195, 0.20420715233176587, -0.15496764913046046, 0.3104088539581595, -0.3132820579726601, -0.16550169324918845, 0.15954561916602011, 0.0019030626220409282, 0.1538673772754115, -0.1298822220961922, -0.26083244118448523, 0.18031839114747183, 0.16080861931505921, -0.26066948101002246, -0.03324134300343321, 0.16130370582505885, -0.35274009084425906, -0.006489138646752217, 0.4507001915169694, -0.05612406790987639, 0.08106081516681284, 0.15657645525304514, -0.39668974052582334, 0.2960671753919424, 0.1543558355688497, 0.179775388240336, 0.179418281311884, 0.21619072292624472, 0.17419558852800235, -0.13660344440799074, -0.006294336415850978, -0.30359458616160395, 0.1408531946355358, 0.08340084817032237, 0.13059760867535605, -0.21546015981690356, 0.1092043532551805, -0.1926996932094708, -0.06313771016652125, -0.4060982239615821, -0.2014682435430462, 0.21588735673642073, -0.4251045038705488, -0.22826463529947516, 0.06495555327829923, 0.3740879050077733, 0.14918851586793977, -0.05377534427774682, -0.19828917654040512, 0.21537026107600873, 0.282761736255506, -0.0950384659244056, -0.21256261333145615, 0.31016246952538723, 0.07138268252492809, -0.0921252390214106, -0.04613051526534167, 0.0016261732536422937, 0.07225668756792106, 0.38609576048812183, -0.18218607052119165, 0.1314187099045899, 0.2556152457543068, 0.41344782155138454, 0.30417304607910306, -0.4494239138568757, -0.23314892915403795, 0.03795047845864552, -0.09675222820665355, -0.1610617352507067, -0.0418480656475021, -0.32681592625438594, 0.24956496154801464, -0.2551959190225271, 0.02541080863071056, 0.352123012603934, 0.23778551814786006, 0.13229516822866333, 0.13818415506999798, -0.32345645977028303, -0.37372295598927, 0.41285085895321, 0.21662080199981815, 0.011470092358178403, -0.3788433150208417, -0.2979187750072312, 0.20983147676977593, -0.013401153454122995, -0.19722188815365888, -0.38612241590826957, -0.10709373488937943, 0.34375590735213024, 0.2089677909503422, -0.3114337570226177, -0.5153667721057468, 0.2700894805232327, 0.13823246516335294, -0.0006000860942798209, 0.42789446399320114, -0.00624585539680585, 0.031015504434697878, -0.3109225472461671, 0.2378722040686459, -0.31523153817073274, 0.04061935908587649, -0.231393380587597, 0.030615958682904006, 0.09885586631210817, 0.33312701680796086, -0.464470481551488, 0.1511023973470373, -0.22347660520541843, 0.15191739056696768, -0.10609040315607593, 0.5638316944520392, 0.38046559741327707, -0.0003329330630175166, -0.3971183732435708, -0.6494042544818011, -0.2894514237226279, 0.1429353755105759, -0.2290582353479127, 0.24848463772252902, -0.30553092571016904, 0.250952955689528, 0.2644482998003364, 0.019431042547197973, 0.09817318373029402, 0.09091689253366543, 0.5130698795769124, 0.32771545539807156, 0.21302377482152654, -0.28035690257805035, 0.28065508431674485, -0.43210393649068346, 0.010899081897831068, -0.09840335234678688, 0.08726009566118004, 0.5301224384429498, -0.04178282005976401, 0.040281345860105996, 0.06370737708251428, -0.06989608464395664, 0.2634925536843406, -0.14570894844517934, -0.43058155248236385, 0.33715237302959333, -0.14895886868397878, -0.11373958238360055, -0.09809516027811603, 0.22762267243261425, 0.04952958682372485, 0.03310585813658388, -0.2705153601650088, -0.05799154978626821, 0.39071093044467553, 0.11301936148051125, 0.18034245428719448, -0.15899564811233943, 0.26810191771745384, -0.19522301613145998, -0.2547185201462608, 0.15002869806911737, 0.18993643093176663, 0.0709548729148087, 0.07608722045987291, 0.31208703430449586, 0.3524763127192338, 0.2541083065663996, 0.25226747840891633, 0.25322705256232697, 0.34472335114265507, 0.21398684501402596, 0.3517710686794394, -0.6367720151814396, 0.08683691818888468, 0.4164743009014481, -0.4626141268698384, 0.21413853804816269, 0.05858894899610225, -0.3017384807730564, -0.16458457251095254, -0.3360930716863562, -0.2726489469132492, 0.019279731421504933, 0.3196843064379988, -0.11323395820602293, 0.36826885808370685, -0.020369928942840718, 0.6005281218247422, -0.08185567173315149, -0.037327285915676425, 0.12738130393104283, -0.057146605347522965, 0.21492361133234664, -0.006112417593531087, -0.06869695495406423, 0.07269501403558723, -0.17856527794269422, -0.12363698503449112, -0.03629754984703438, -0.04469328024176655, 0.07572346049797814, 0.06278083613014356, -0.10986811992655404, 0.1557828118406078, 0.07058701440596782, 0.04257218301019461, -0.05068687370218647, -0.5072454185690092, 0.3163015607031341, 0.04534619651447847, 0.169137073360174, 0.20894111247636835, 0.20415023708565183, -0.5837517619784715, 0.4107230083915739, -0.08694076999762751, -0.07420635551847381, 0.7907784969468508, -0.639480237473454, -0.008350427941089611, 0.22640748196001093, -0.11594414127088377, 0.21096979965555349, -0.2901973424741974, 0.2706291944931596, -0.23838221451774613, 0.010997107361497562, 0.4253048711804523, -0.6270324535166483, 0.413505833252188, -0.2090530977153494, -0.19528125775332175, 0.2682646144338407, -0.3117798708540279, -0.11134926622023818, 0.3496913185351583, -0.300558815300203, -0.2104429265471231, -0.20588314676337682, -0.39146829962761065, -0.344750260512425, 0.03205238957817965, 0.13217570435808793, -0.08600429182000596, -0.41324071876026774, 0.18429489621478695, -0.27046627275198776, -0.17636278984479217, 0.33255835452810106, 0.1540484121159446, 0.2283133910332109, 0.19683242799183678, 0.2076812507302363, 0.4436963333583103, -0.10648108024529823, -0.29918941182622905, 0.14896647276852526, -0.17511084887226108, 0.04305220748323652, -0.09925659234728951, 0.07552273651037232, -0.0030331841960251718, -0.40990673047929704, 0.22310665140409128, 0.2768864855412102, 0.3276801542709038, -0.311074611759482, 0.20717630315381166, 0.026272696579722858, 0.11759090960267485, 0.33408239478730745, 0.05977781764709571, -0.2675728635398554, -0.20882890668712048, 0.4134188875635406, 0.2966289648255653, -0.17177964833374137, 0.005976534195809025, -0.22439498306462788, 0.17877534726792896, -0.3834345945715508, 0.10545378586696681, -0.31213182750998547, 0.22890433462767357, -0.2912524825704814, 0.0328003750906008, -0.3397534927689087, 0.04759173787313718, 0.12835834385420986, 0.19620591878186422, 0.15499174462899074, 0.09707870864786468, -0.36852827340015004, 0.06088171559173974, -0.6897723151287837, 0.37196829755827227, -0.2483241208164897, -0.37291485420750015, -0.009453934426259615, -0.2305241870646073, 0.30525120485435403, 0.1721051552557645, 0.07625499717045611, -0.21644245375015034, -0.17490079345637366, -0.16848218132299944, 0.36709445846752964, -0.3445756198124045, 0.1656879910607265, 0.5892949687364719, 0.2999670871489314, 0.12150417974706894, 0.23069760765560146, 0.04327850331931805, 0.0849827793572471, -0.2182384319370999, -0.2464078105933027, 0.16391092784085598, 0.5925290652376635, 0.0007615087643055753, 0.25610034139190974, 0.6707863252652558, -0.4761756939203003, 0.20983736819964188, -0.7470993890058495, -0.2792584148019112, 0.4031475754097392, 0.08176403635091985, 0.16936132356738764, 0.13809076485079577, 0.16129093516060708, 0.042231993283929944, -0.25539202977360537, 0.09028225917235962, 0.09119928110507007, 0.055200981917270714, 0.40357089783434813, 0.23927652301621616, -0.2908829857343071, -0.2267798905515774, -0.061181101470698974, 0.1988309096440325, 0.3961138341079633, -0.25569169610442705, 0.35895382962296846, 0.14275589919481194, 0.19361217839536585, 0.26687530902108847, -0.3203679856403523, 0.3402430224038796, -0.3134044999824543, 0.10319510677371475, -0.2985433030836845, -0.056496201388673346, 0.020190721895383682, 0.28651652695598456, 0.14133812886171662, 0.19453248739806375, -0.06563828035021489, 0.5957603055504078, 0.06680120137038598, 0.15377459644348282, -0.2679812617636812, -0.18821770459829673, -0.2397322451110273, -0.1233915808597145, -0.5581258245547166, -0.23394966444986973, 0.418282987951899, -0.5494272792744439, 0.3288128800721625, 0.2623918843888093, 0.2718091627133162, -0.3640824053357062, 0.574729180351912, -0.011648948013538654, -0.29939424792825114, 0.37414146622516564, -0.3993316092504021, 0.025396196111482354, 0.07798421442668543, 0.06474576896083108, 0.1483334333726978, -0.5032216384313867, 0.9242639027147256, 0.22179515734605118, -0.19184692274176282, 0.5475154541311443, -0.6520552576235903, -0.2902490688105908, 0.19636306053034813, 0.23154945313028236, -0.18411873519418756, -0.09960570506452089, -0.17692702706505062, 0.21396614611196635, 0.4178857066969841, 0.13236360996581614, -0.20665286579078687, 0.15423992024077038, 0.2776388662521959, 0.15730289904829373, 0.12521530161082786, -0.2146561241606987, -0.05765773999993789, -0.19164875610530702, -0.13724531107219043, 0.08385652122939724, 0.43691801700204674, -0.047584542414047, -0.27366058817986444, 0.0552218537053744, 0.2841566274424703, -0.44078353038287676, 0.07864496511985827, 0.08566206958997799, 0.11287439130045411, 0.015061114785889302, 0.1667184496598916, 0.1878024381319117, 0.09965699735578336, -0.2093083751362999, -0.342627548997847, 0.671654821925792, -0.06103416470287768, -0.01880913338973906, 0.26316551499598756, 0.18275021848957718, 0.4719382366529779, 0.11906406269905725, 0.1706010696991976, 0.06215793492880927, -0.17643392742872915, 0.34239922972548825, -0.28230404912658835, 0.3102950022676891, -0.044645592181553485, -0.5388655563256843, 0.44251374140696864, -0.031182858429387204, -0.3059535764722629, 0.5033253911167368, -0.0278312280129041, -0.07182113433162342, 0.1357981776752919, 0.33000438258987896, 0.004235701410099376, -0.04826636602175774, 0.07879836968789888, -0.19870670669822374, -0.347813792577316, 0.007413027526200133, -0.11549898350596252, -0.31714308724628903, 0.05669009277758371, -0.008602410112363176, 0.1692173269123, -0.2888167320228546, -0.35429501811398906, 0.08775728204754883, -0.08920226875870128, -0.04387217255712351, 0.16831275823045524, 0.17744346168394348, 0.5083726278872538, -0.05205490739918549, -0.013924154948127737, 0.17225492824231772, -0.054888250657515326, 0.0016846901462030035, -0.0880330538247709, 0.03421040046788444, 0.30968643995530337, 0.46473925976088887, 0.21581519931906454, 0.268244634066291, -0.17438928231029632, 0.23126445501672013, -0.02894040397511339, 0.02318273026866309, -0.0007844291450242547, 0.4626642981596064, -0.16466588277584068, 0.2644609454270389, 0.0015601376416302434, 0.1776357395394415, 0.31617296609644124, -0.1817522792144755, -0.31309036660363426, 0.13599156265081214, 0.301694262373866, 0.3114908816395699, -0.3912519842664316, -0.04249525239633094, 0.5539641235028291, -0.10032338527396487, -0.02165111162574275, -0.026915332571224772, 0.18684313794956756, -0.12613366641015886, 0.3258603377298989, 0.3984101805215644, -0.06794116577490728, 0.10968138145521254, -0.011960681416619514, 0.12598951193166386, 0.19768965755439724, -0.24766506582600437, -0.423035525290879, 0.16053855458184196, -0.05228751343480462, -0.15408988458051917, 0.04793716360343734, 0.44289862420262927, -0.017964550892542286, -0.07297040868596047, 0.08036749539694397, -0.23676934901314023, 0.10647623083972943, -0.3456811867235559, -0.314275002072994, 0.30949452752266116, 0.31963765955889156, -0.24000152399247188, -0.1503178791275085, -0.20413768885495787, 0.2035421075185528, 0.06561879656034238, 0.03938613700207722, 0.3563831565255502, -0.12379007563178344, 0.25495220360699405, -0.1373514626884163, 0.2716511857473684, 0.48488607099656067, -0.10836710667386627, -0.3859261579686567, 0.09291111016418936, -0.2849222374658433, -0.14618936893757892, 0.05041705327997318, 0.02561600314247658, 0.06323170934748693, -0.2779110503412594, -0.1429681112495878, 0.37319536306952245, 0.05222989944248242, 0.01209041343470021, 0.2769080925610845, 0.21357907317647387, 0.43003784946860163, -0.05181787857018, -0.2294086491044858, -0.3016018204798299, 0.30998322870485684, -0.16989094768403615, 0.25136868381180266, 0.35311315157385703, -0.1423105872105829, -0.008354050960765998, -0.21959418766115843, -0.37245936484634445, 0.29080391303804254, -0.507530208179603, -0.09127810505702165, -0.27031161358756034, -0.12553887124415306, 0.3239044679099523, -0.35320289747792183, 0.37401220107087907, 0.08475270306743497, 0.10952710213305875, -0.08278572553583043, 0.03543543658749927, 0.3535805853101479, -0.3546749927963183, -0.45968395558158687, 0.2720235756256307, 0.28175214622839345, -0.24150066925020935, 0.16302529726017986, -0.19841961649878934, 0.07441470336431354, -0.2039388639281284, -0.25350150208790406, -0.3006206910038556, 0.17907532289848735, 0.05515120536683933, 0.10890163303385818, -0.0029672297535693662, 0.5109255909825511, -0.44422004160973494, -0.4835071798663127, 0.5799916476852283, 0.18247393191502612, 0.48295280844828753, -0.09111310072719797, -0.14811773069002432, 0.1426425888247278, 0.03208018713763338, -0.2180365024982514, 0.5783469047502965, -0.09372564025380985, -0.0008803474559720289, -0.16009523859972735, 0.06613050534725091, 0.7748574589369878, -0.23106136834075225, 0.09648810092138162, 0.30163942180238573, -0.0011874345442736895, -0.02278920312636019, -0.040769230580665464, 0.033203248504575684, 0.1297014967218805, -0.016814717172144077, -0.008581958117864111, 0.020016174909178338, 0.10572260649981485, -0.13158053791668922, -0.010361148499443416, 0.07451133299842999, 0.0032229153625029407, 0.050194806636847764, 0.03253692747384774, 0.09050498848975934, 0.23653395372582534, -0.045799543817403164, -0.0367476235604112, 0.030675053639049033, 0.21037039481317046, 0.4538608527883793, -0.05139861742793632, 0.43961618655483903, 0.30987129737922925, 0.05748750491468992, 0.3675350714809255, 0.34114800705416337, -0.23119248343733678, -0.27396177719013126, 0.9533331711285776, 0.2905604440358483, 0.11777943339786748, 0.1424126581253233, -0.31444269790387536, 0.3692925968638001, -0.32531133462710315, 0.475359460601412, -0.14146118445206293, -0.3465133629550524, 0.108052343139271, 0.20713893191890226, 0.21200207993663298, -0.16622701224637024, 0.3900761054437896, 0.4938088621364913, 0.8847358023609221, -0.17487377388798175, -0.3993596470014865, 0.22054383291482665, 0.3887960725474899, 0.1189057016891343, 0.1596862659189132, 0.06386094608962199, 0.22261829345839415, 0.8771136326324508, -0.6253531139970816, 0.32082974222456057, -0.8807826673634825, 0.25978011384582284, 0.384509552979104, 0.6038933085942407, -0.2823515015696355, 0.0330328636252404, -0.6658036699445715, -0.3224268502353984, 0.3643788241159234, -0.16930632733390233, 0.2525840376291796, 0.28469813739591293, 0.24590791970529913, 0.0930267811756897, 0.2614440988675654, -0.4182807327809413, 0.15858206270054928, -0.6671193398404459, 0.5097441440151292, 0.34893116122370305, 0.29707588484623426, -0.0640385305808045, -0.010344269166648472, 0.19408752522137285, 0.1331849100269053, 2.284005565392621, 3.0311402807228505, 2.027557914843174, -0.20414161237592438, 0.26927060086593463, -0.9211131843032567], drift_posterior_p = [-0.2556702704952233, 0.05907459918336679, -0.10115495626856393, -0.3163134235262557, 0.019559664733039016, 0.2583671761072438, -0.171117349705544, 0.38570838096505194, 0.3255848694422387, -0.31978978113829737, -0.37460174246831474, 0.33924454067612386, -0.27171004859772746, -0.07332804098439152, -0.03473427380183079, 0.8237583317156889, 0.1635910119640296, 0.6695997463495491, -0.07585125256398707, 0.24605438778098307, -0.035520123243473506, -0.15953154307290973, -0.2949580818219081, 0.15984573826789714, 0.2928327844064856, 0.21390221851051275, 0.17400445920829083, -0.09464802887533384, -0.22694076032568436, -0.3410926763744606, 0.383732423001005, 0.6277288259330388, -0.08270368745064775, 0.11153726385968023, -0.091781425529397, 0.2028292945914233, -0.19053754520660737, 0.42096272196685663, -0.32205638157258, 0.04276546596322098, -0.15512207868603237, 0.4080040185010912, 0.37218811649915534, -0.17253647597165858, -0.5296813410365953, 0.31745305016902603, -0.1255315908585522, 0.523877867807308, -0.11361983585656034, -0.3809750269616829, 0.34875198044119393, 0.3902811551943448, 0.459540249946407, 0.16404624534265674, -0.5472885211717541, -0.5271625559592481, 0.006057245607465529, 0.44062127827874803, -0.3216857330582681, -0.10957793840920511, -1.2330489482077895, 0.7771041225133455, 0.72692877050845, -0.2864375688356364, -0.555553221541131, 0.08029288581589981, -0.6837982061903681, -0.7478050342119689, 0.03339453276324538, 0.3942938177598962, 0.061211566622578, -0.3867770718074928, -0.05124256110593687, -0.1612616774629223, 0.7597036125422498, -0.8660488669860025, -1.0661477469587084, 0.11927132402685149, -0.09749028415667246, -0.8023163111739665, 0.6926739695484162, -0.7607258458345144, -0.8007463341859098, 0.6658471328622979, 0.4411057037583582, -0.7675786786194806, 1.3050233192163725, -0.9971325976914374, 0.2463047337281731, -0.37520129486561754, -0.14252076223916707, -0.3195363837104574, -0.4310392234396292, -0.713146953132183, 0.6005095258281209, -0.05181013700711945, -0.2296234291295664, -0.15303824629259738, 0.7479832407106171, -0.4045207505495572, -0.326131958192386, 0.04601633207855455, 0.28641310492185756, -1.0688483652626, -0.151082104980446, -0.1511520063429333, 0.40262342742113955, 0.334607611230025, -0.40629009448226844, -0.3000271658722737, -0.10163468230410282, 0.6633467302874795, 0.6687536802973489, 0.34002131894647547, -0.9300725347773395, 0.5355614288558458, 0.42949025537092184, 0.8572868516805362, -0.27569649390516515, 0.5650087472199834, 0.4981716542882053, -0.8900473357184651, -0.3622562457759094, 0.34951899429141003, 0.6008474707873505, -0.5202301828694619, 1.2368752865518902, 0.5696720818213614, -0.04929405967149576, -1.1233337266849184, -0.8773379866674802, 0.18865234300719141, -0.3929543648955713, -0.14839189719283769, -0.2343219843618806, 0.2258782217149652, 0.0887087965743416, -0.19301822904770385, 0.5279631663359554, 0.409593491364933, 0.06512129381912792, -0.09950208678678893, -0.15726200957221445, -0.04394221032696841, 0.0919693753533007, 0.19581061439962594, 0.0030705147867097276, -0.10391632857325717, -0.05600688253960077, 0.3142672432874549, -0.26828414359398167, 0.05589850474224451, -0.25639021024582737, 0.11623745179878281, 0.022314688242696463, -0.04303726965047786, 0.3238662926076746, -0.16422084125461936, 0.07983219507657782, 0.10535497870614044, 0.06907145744307877, 0.5447292910779639, -0.6470995447137465, 0.7334164413283258, 0.5232004837640978, -0.37641841451116664, 0.5322680252267545, -0.36603982907047156, -0.8408986086478449, -0.4875195593702094, 0.9064461141816421, 1.4176514025341984, 0.5165763490985381, -0.8563399924562003, -0.47125849582961143, 0.8922046639022505, -0.46217424077339375, 1.7707619190578405, -0.4640383226550247, -0.17570855552592685, -0.49815750378774104, -0.721892194911722, 0.1891046617107761, -0.8064162318616576, 0.3775298887395792, 0.6767463485756383, -0.13416091543529993, -0.16978832645087147, 0.5353566045562307, 0.576790005939434, -0.22044909182559086, 0.23465456128013373, -0.40681363929878084, 0.07442919798955705, -0.2113517381360673, -0.6473019561753768, 0.4492471865419162, 0.22635556934078557, 0.6279230440452798, 0.7442941329633826, -0.9561828807822083, -0.7307153918239607, 0.41068952959432503, -0.27356388856562286, 0.0441237570666384, 0.6170679036176585, -0.3750529770264147, -0.14950867702881868, 0.7905049242912482, 0.7139211555331435, -0.5954281776371017, -0.439155789009118, -0.9659436764984002, 0.7287693764589194, -0.6014584923600911, -0.6731730389463069, 0.4630569449182162, -0.6416950872752597, 0.6020273261990702, 0.03727016054820232, -0.40998359711229715, 0.2984375867303202, 0.2679187389381099, -0.09338459645212356, 0.8472046959954811, 0.0012854858228809403, 1.2047765272613595, 0.4587657452459728, 0.021356207508452688, 0.5579114261758247, 0.935605300681402, 1.5597512608627362, 0.4317656895109436, -0.02376994014779793, -1.1810293513696, -0.10818779689543044, -1.0355661754314924, 1.1436048310629265, -0.5114646560692855, 0.02414890093898059, 0.04817592002306642, 0.26646026403794926, -0.3833584885005068, 0.6907763148423535, -0.37367336296567494, -0.400304313357424, 0.24276273105278964, 0.10425627518660159, -0.4546773301100653, 0.05373618650857811, 0.3836591816490644, -0.2523308719650092, 0.34652698117498026, -0.3152173641188553, 0.4021377044096543, 0.19206341913410596, -0.269500399044882, -0.527730999231382, -0.4410941047954011, -0.17280588736414937, 0.10932049805086072, -0.39665221077423596, -0.1885138521282247, -0.306748398280954, -0.36227505242919594, 0.028562972988285636, -0.33451375781205045, -0.29687286422519066, -0.0027560776308405382, -0.1440287178977308, -0.3003528772900822, -0.4428251718986991, -0.4881412994478384, 0.36786078371144143, 0.30967923832453986, -0.19499697006088157, 0.3001485051581386, 0.22481912669223955, 0.29174152598047143, 0.06817534529647978, 0.7132388043763943, 1.055922569496315, -0.6582448297572657, 0.6048736907164773, -0.1860824345350849, -1.1650076251626051, -0.46409515697047354, -0.28248918223150826, -0.7666958525493592, -0.30689956840544336, 1.2558204709234448, 0.0546494696229437, 0.9603444428013789, -1.2744252471436928, 0.007960804408068378, 0.7573794746230846, -0.1600662473622435, 0.9731146133703074, 0.7698195728703355, -0.5387319010413346, 0.3188900939804982, -0.18879290892626063, 0.3191252951735171, -0.2137553168121554, 0.13646991088484695, 0.059064338144939346, -0.6232590191116605, -0.5545730527959648, -0.3954940919094764, -0.015344652194485515, 0.056686066421179855, -0.008165220213411217, 0.06770953821786681, -0.24165799455181028, -0.12702413953890468, -0.07555725869051741, 0.9155188405856853, -0.30297924063002024, 1.24096002525494, -0.2835638424036464, 0.23108995022288148, 0.21809058853134594, 0.032777347070769916, -0.0026960686063128513, 0.06859404303351355, 0.17436695776416133, 0.6274205893336968, 0.4269323036042762, 0.47046393334498715, 0.3191397779396415, -0.2684467583580096, -0.19695261852781454, 0.1452129772843779, -0.1822747688894226, 0.05209336113655696, -0.10833103720495961, -0.739286896783362, -0.038344187747465196, -0.3054491062118597, 0.3840439040168932, -0.2216567203646395, -0.23789667444566293, 0.08895454912565973, -0.020087462432115316, 0.06163414578658858, -0.24691367011104629, 0.0664307151237478, -0.08380777920991188, 0.4574298945578998, 0.3394233796083776, -0.267502914838199, -0.32754460473233316, 0.1481319374668559, -0.1126277903985052, 0.3896417866778453, 0.014739837031621005, 0.011660404302413288, 0.06163359110020895, -0.4218554421346867, -0.035690335962016, -0.3300332475449865, -0.03554538821181034, 0.09660701404621568, -0.046947994948318056, 0.5912597938440003, -0.0852751790433619, -0.07518668409441684, -0.30535059789544383, 0.1288781643167622, 0.12359912357977688, -0.16020228504589828, 0.34342899278057887, -0.4172555266275357, 0.07568769156203885, -0.1709410293686252, -0.311769338126109, 0.15749270521861336, 0.7428871862183177, 0.17310210107074464, 0.3519743180329379, -0.13733072335650026, -0.04949666114079813, 0.15374208401185582, 0.03987777927752723, -0.11913820419116639, -0.2683505756989259, -0.4643820358867324, 0.09848958392548782, 0.13385475790240142, -0.13380594200420567, -0.059955286091724146, -0.11689706942599097, 0.10614002558230473, -0.2538003205819162, 0.10628055571531347, -0.40469157089415747, 0.8191690586075395, 0.3417767527636252, 0.5439687622982169, -0.403040614256876, 0.10345255379107403, 0.1659975300832391, 0.20421346153261824, -0.0923780856054839, 0.2746968116012402, 0.2318300588533782, -0.19852561356391818, -0.41458723626447014, 0.24180424304344175, -0.1710016808744432, 0.2451956581295556, 0.2647766500565973, -0.31745002374755604, 0.301544931997611, 0.21487230326096146, -0.30977150523431046, 0.44905451175618716, -0.12965307433419404, 0.9125698660656263, 0.15734744580114646, -0.28244872891726197, -0.23268415826337804, 0.5470123446882412, -0.3937669871452553, -1.1107316336149096, 0.148805467541673, -0.9648202394614309, -0.7073704204900167, -0.044814523760541854, -0.8806156069596119, -0.9527013687717762, -0.6306368967873326, -0.23316047047059899, 0.050727283169771355, 0.6121079867490699, -0.42344858718372846, 1.4038180937781237, -0.3944876607630135, 0.6204297378447463, -0.6155021385047421, -0.3982136460015858, -0.32569781454262, 0.403739131054892, 0.40017714554878914, 0.1647161648229929, 0.25588946046066596, 0.9856535463571544, 0.7021912499347542, 0.507737172825581, 0.36930939885945424, -0.6608790723136002, 0.25335397739421345, 0.07439246036684753, 0.680494599988699, -0.4003395770442414, -0.05068326007209929, -0.7860458241886444, -0.017541653069323915, -0.7789659088413927, 0.41932254571232375, 0.37074077127710275, 0.39066581920788507, -0.10028561277788856, -0.2759547272637546, -0.11445771219146449, -0.04741291302986578, -0.24858825692349806, 0.35280000307301845, -0.3273200397376756, -0.3790599958391255, -0.006180750331842917, -0.2986952826308137, 0.14372899979278875, -0.586279934358776, 0.02953882139914221, 0.28618834812734445, 0.3020807275662598, -0.23348447611276313, -0.4657553149323334, -0.11328733762803725, 0.5316070039549442, 0.8914889153755453, -1.0254553301232168, 0.11050897200503627, -0.8322825286440871, -0.794799945709754, -0.7141458295398413, -0.3125323546804379, -0.29233923165168996, -0.7936092174770071, 0.0158145596243679, -0.706435803550631, 0.6490227071527185, -0.8418031204951109, 0.8398343434897555, 0.5445649931708878, 0.8567235570637839, -0.1087553097559762, 0.996713892165825, -0.7932967021307437, -0.18402529379068897, 0.03749518396744955, -0.14293066213200595, -0.3196392646655373, -0.10176140584264266, 0.19017937211079894, -0.4166590526745307, -0.2954975218469572, -0.23232878678047983, 0.011395145195345065, -0.1076952692933642, -0.29428816832242527, 0.2856540621592502, -0.1978807413864564, 0.46198991016585816, 0.18903968040310717, 0.5439171470024404, -0.17908967227813252, 0.4329341298872535, -0.30254590765962663, 0.5689169236263503, 0.6281479928828853, -0.5046028231772086, 0.28516641362264106, 0.1337737247170438, -0.07395884487617495, 0.584593260268391, 0.36121683877263416, -0.019392432691815096, 0.3911029819627243, 0.13980668956351372, 0.7927952139964625, 0.5770896217869416, 0.1709465276506686, 0.03642887576204293, 0.0596142820836092, -0.2919358777487089, -0.37276059462359823, -0.4354074403455487, 0.1644907206165085, 0.28746647873761305, 0.18208412123677367, -0.17285676990577986, 0.2987326244921398, -0.5454083980141081, -0.10727464961551736, -0.002710332648251369, -0.2538045691982891, -0.36785772703425534, -0.016047067946379067, 0.10030979596728073, -0.2577019686386777, -0.17903972017445316, -0.30061416529279655, 0.3635280894406499, -0.10741441328655112, 0.4076600589010835, 0.25320932548392816, -0.2883335031215885, -0.4277327721101879, 0.06771249751602776, 0.1713512365324513, -0.04640420684558901, 0.015815890029417627, 0.03411457462648845, -0.12906456571069364, 0.06565702132193285, 0.10974176177927683, 0.11980546703226294, 0.14978740845978555, -0.1180905456514241, -0.04117004714877212, 0.05901233422544926, -0.03662775082738605, 0.06596875299302656, 0.13438241344565072, 0.01142581935836786, -0.17973486528689742, -0.09024144079551653, 0.07526879860840968, -1.9457755763108475, 0.7321893745301095, 1.6998334799459747, -1.117577861171244, 0.3407730473310461, 1.4546632006997269, 0.989958538243434, -0.392638815755635, -0.7110784288843138, -0.32416581339483896, 0.4019258822907927, 0.23382882058371243, 0.6660418990971122, -0.1594494376559351, -0.6128502756080734, 0.7625955294767723, -0.453004201863963, -1.0879703030828232, 0.334993114651225, -0.031812188743143795, -0.381860402954794, 0.23624811291244185, 0.6993609161597968, -0.4388002608306046, 1.3853072967699107, 1.119238975492751, -1.7735746595591984, 1.0166674794426114, 0.43212423471012934, -0.9781710585402001, -0.4592044690689081, -0.47777729843391226, 1.9711625463873925, 0.12405139192667108, -0.61884144218291, -0.09018368308904338, -1.0459506757763015, 0.6000047615461495, 1.2209721767303814, 0.3267303444282918, 0.11656499196682772, -1.8023599726536184, -0.6281288284805205, 0.6550276542183735, 0.228581105371765, -0.7073906368278662, 0.3359866556173353, 0.02721481033916025, -0.6968822875632883, -0.06984410225115602, -0.5096614583113495, -0.36195504416106333, -0.9235039270684092, 0.996465801898438, -0.8380117993389536, 0.14559442556224467, 1.311086158833672, 1.2915160878459637, 0.4903533534017363, -1.6079280274321748, -0.03062021108072338, 0.2407728941363289, 0.02465868857502834, 3.7323432373681062, 3.1759445492481406, 3.2483914605587896, -0.04254983889906858, 0.39479979152541783, 0.23575668984130604], diffusion_p = [-0.47765661377472424, 0.6357977989223882, -0.14792990159771977, 1.8707183526427333, 0.6145590705502822, 0.43611960385571713, -0.010317081415891279, -0.48332314037454777, -1.138238752181981, -0.4797742541050379, 0.786650732727629, -0.18085335004447348, -0.20705204481854914, 1.1757412969679655, -0.7801850359621259, 0.9030717812635342, 0.8963337143472325, -0.016603405214282094, 0.7213938346945723, 0.18706284096572012, 0.25890088514559945, 0.46861298911809945, -1.3886749010699693, -1.1429137857358305, -0.643702457456291, -0.17206402320556985, 0.7632024771270071, -0.6025188148426556, -1.784851904453155, 0.549741914109388, 0.4223660816207082, -0.07931173125895302, -0.7314880261720151, -0.11106232041105636, -0.9364822186911855, -0.21544586519170722, -0.3321640577685889, 0.8488609942058258, -0.6089696054641496], encoder_p = [0.4310796856880188, -0.1564745455980301, -0.2790025770664215, 0.32293665409088135, -0.029417384415864944, 0.10011578351259232, 0.08167217671871185, -0.4058156907558441, 0.02978740818798542, 0.21646593511104584, 0.1837470531463623, -0.03039354644715786, 0.3631804883480072, -0.2597687542438507, -0.2881057560443878, 0.18328341841697693, 0.29528307914733887, 0.19500553607940674, -0.4282739758491516, 0.3501529395580292, 0.44827860593795776, 0.09499610960483551, -0.4011346101760864, -0.12588103115558624, -0.3064194917678833, 0.08380003273487091, 0.007921045646071434, -0.3221067190170288, 0.06708426773548126, 0.0019201388349756598, -0.10411644726991653, 0.09676839411258698, 0.26943492889404297, 0.34509947896003723, -0.12942413985729218, 0.18618255853652954, -0.012280049733817577, 0.3132334053516388, -0.11702664196491241, -0.11059870570898056, -0.0851144939661026, -0.26091107726097107, 0.4146385192871094, 0.3800686001777649, -0.2389996200799942, -0.038073521107435226, -0.052187610417604446, -0.3998015224933624, 0.35727426409721375, -0.009910650551319122, 0.18730227649211884, -0.3871683180332184, -0.08313389867544174, 0.05513373762369156, 0.2703809440135956, -0.34749239683151245, -0.07002026587724686, 0.08322234451770782, -0.257688045501709, -0.015458991751074791, 0.42598965764045715, 0.40707290172576904, 0.15762129426002502, 0.26828327775001526, 0.041621435433626175, 0.1812635213136673, 0.05806030333042145, 0.3847128748893738, 0.10490471869707108, -0.2885902523994446, 0.40761274099349976, 0.3032993674278259, -0.4085453748703003, 0.12999217212200165, -0.15482214093208313, -0.20328298211097717, -0.1853734403848648, 0.005667226854711771, -0.03495146334171295, 0.10366681218147278, -0.3984021842479706, 0.24918104708194733, -0.02783063054084778, -0.33549049496650696, -0.3748747706413269, 0.10323962569236755, 0.12114425003528595, 0.14849166572093964, -0.20721681416034698, 0.4245603084564209, -0.15306806564331055, -0.167749285697937, 0.07884591072797775, 0.08585900068283081, 0.16113534569740295, 0.06572934240102768, -0.25546759366989136, 0.3829953670501709, 0.13171207904815674, -0.03063521534204483, -0.3868297338485718, 0.2072511464357376, -0.2160273790359497, -0.12530647218227386, -0.03495141118764877, 0.3470931053161621, -0.39909103512763977, -0.03483284264802933, 0.2844665050506592, -0.39764198660850525, 0.35323581099510193, -0.30750134587287903, 0.09179406613111496, -0.1895224004983902, -0.2960474193096161, -0.032901402562856674, -0.3796003758907318, -0.13819919526576996, -0.1515687257051468, 0.23338629305362701, 0.3824295103549957, -0.3930381238460541, 0.41503477096557617, 0.05630825459957123, -0.006062322296202183, -0.36605602502822876, -0.06479857116937637, -0.24803899228572845, -0.17148204147815704, -0.43837329745292664, -0.16066983342170715, -0.33772212266921997, -0.0980897918343544, 0.06756631284952164, 0.32119518518447876, 0.01199754886329174, -0.2559008002281189, 0.4311824142932892, 0.3628380000591278, 0.14328445494174957, 0.22363926470279694, 0.14999601244926453, -0.06631326675415039, -0.06383708864450455, 0.2924171984195709, -0.264708548784256, -0.16897381842136383, 0.1323089599609375, 0.29843148589134216, 0.40776658058166504, -0.190637469291687, 0.09345665574073792, 0.35584574937820435, 0.1761167198419571, 0.10512398928403854, -0.016766894608736038, -0.19568073749542236, -0.4078931510448456, -0.2464423030614853, 0.21671371161937714, 0.37406331300735474, 0.27171042561531067, 0.24236686527729034, 0.19766773283481598, -0.2314554899930954, -0.33643126487731934, -0.28005450963974, -0.14334720373153687, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.2554247975349426, -0.7549784183502197, 0.4911440312862396, 0.5954092144966125, -0.5272296667098999, 0.4999324083328247, -0.6739473938941956, -0.7647075653076172, 0.05286497622728348, 0.6352071762084961, 0.5419179201126099, -0.24170181155204773, -0.7065765261650085, 0.5737209916114807, 0.45186805725097656, -0.22098912298679352, 0.7260597348213196, 0.36472105979919434, -0.16796883940696716, 0.0755566731095314, 0.1372394859790802, -0.21521496772766113, -0.6893054246902466, 0.07744879275560379, 0.0, 0.0, 0.0, 0.0], projector_p = [0.568331246633007, -0.07214705274920853, -0.4599054121610163, 0.5897619104547192])

# ╔═╡ 9ea12ddb-ff8a-4c16-b2a5-8b7603f262a3
md"""
Integrate the prior SDE in latent space to see what a run looks like:
"""

# ╔═╡ 9346f569-d5f9-43cd-9302-1ee64ef9a030
plot(NeuralSDEExploration.sample_prior(latent_sde, ps, b=5))

# ╔═╡ b98200a8-bf73-42a2-a357-af56812d01c3
md"""
Integrate the posterior SDE in latent space given context:
"""

# ╔═╡ 26885b24-df80-4fbf-9824-e175688f1322
@bind seed Slider(1:1000)

# ╔═╡ 5f56cc7c-861e-41a4-b783-848623b94bf9
@bind ti Slider(1:length(timeseries))

# ╔═╡ 88fa1b08-f0d4-4fcf-89c2-8a9f33710d4c
posterior_latent, posterior_data, logterm_, kl_divergence_, distance_ = NeuralSDEExploration.pass(latent_sde, ps, timeseries[ti:ti+4]; seed=seed)

# ╔═╡ f4f2c0ac-06f3-4632-b314-aa6e91bc84db
plot(timeseries[ti:ti+2])

# ╔═╡ dabf2a1f-ec78-4942-973f-4dbf9037ee7b
plot(logterm_[1, :, :]', label="KL-Divergence")

# ╔═╡ 38324c42-e5c7-4b59-8129-0e4c17ab5bf1
plot(posterior_data[1, :, :]', label="posterior")

# ╔═╡ 08021ed6-ac31-4829-9f21-f046af73d5a3
plot(posterior_latent[:, 1, :]')

# ╔═╡ 92c138d3-05f6-4a57-9b6b-08f41cb4ea55
plot(NeuralSDEExploration.sample_posterior(latent_sde, ps, timeseries[1:1], seed=seed+1))

# ╔═╡ 18acf95a-4fa2-452d-875d-01dfc7f18bac
plot(NeuralSDEExploration.pass(latent_sde,  ps, timeseries[2:2], seed=seed+3)[1][:, 1, :]')

# ╔═╡ 3d889727-ae6d-4fa0-98ae-d3ae73fb6a3c
plot(NeuralSDEExploration.sample_prior(latent_sde, ps, seed=seed))

# ╔═╡ b5c6d43c-8252-4602-8232-b3d1b0bcee33
function cb()
	posteriors = []
	priors = []
	posterior_latent = nothing
	datas = []
	n = 5
	rng = Xoshiro(1230)
	nums = sample(rng,1:length(timeseries),n;replace=false)

	posterior_latent, posterior_data, logterm_, kl_divergence_, distance_ = NeuralSDEExploration.pass(latent_sde, ps, timeseries[nums], seed=seed+i)
	
	priorsamples = 20
	prior_latent = NeuralSDEExploration.sample_prior(latent_sde,ps,seed=seed+i;b=priorsamples)
	projected_prior = vcat([latent_sde.projector_re(ps.projector_p)(x) for x in prior_latent.u]...)

	posteriorplot = plot(posterior_data[1, :,:]',linewidth=2,legend=false,title="projected posterior")
	dataplot = plot(timeseries[nums],linewidth=2,legend=false,title="data")
	priorplot = plot(projected_prior, linewidth=.5,color=:grey,legend=false,title="projected prior")
	
	timeseriesplot = plot(sample(rng, timeseries, priorsamples),linewidth=.5,color=:grey,legend=false,title="data")
	
	l = @layout [a b ; c d]
	p = plot(dataplot, posteriorplot, timeseriesplot, priorplot, layout=l)
	#p = plot(timeseriesplot)
	#posterior_latent
	p
end

# ╔═╡ 025b33d9-7473-4a54-a3f1-787a8650f9e7
cb()


# ╔═╡ f0a34be1-6aa2-4563-abc2-ea163a778752
function loss(ps, minibatch)
	mean(NeuralSDEExploration.loss(latent_sde, ps, minibatch, 0.1))
end

# ╔═╡ ef59f249-64c5-4262-b987-327d67b70422
loss(ps, timeseries[sample(1:size(timeseries)[1], 5, replace=false)])

# ╔═╡ f4a16e34-669e-4c93-bd83-e3622a747a3a
function train(learning_rate, num_steps)
	
	ar = 20 # annealing rate
	sched = Loop(Sequence([Loop(x -> (50*x)/ar, ar), Loop(x -> 50.0, ar)], [ar, ar]), ar*2)

	
	opt_state = Optimisers.setup(Optimisers.Adam(), ps)
	for (step, eta) in zip(1:num_steps, sched)
		minibatch = timeseries[sample(1:size(timeseries)[1], 5, replace=false)]
		#if step % 10 == 1
		#	cb()
		#end
		
		l = loss(ps, minibatch)
		println("Loss: $l")
		dps = similar(ps)
		#Enzyme.autodiff(Reverse, loss, Const, Duplicated(ps, dps))
		
		#return Vector(grads)
		dps = Zygote.gradient(ps -> loss(ps, minibatch), ps)[1]

		Optimisers.update!(opt_state, ps, dps)
	end
end

# ╔═╡ 2ada3ddd-b47a-46ff-abba-17cbb94041a2
md"Enable training $(@bind enabletraining CheckBox())"

# ╔═╡ 5a17f6c0-ead1-448f-8df8-60e68a96e0db
begin
	if enabletraining
		train(0.1, 1)
	end
end

# ╔═╡ a528a99c-5f9e-4d04-abd2-6b9264fb775d
begin
	if enabletraining
		train(0.1, 500)
	end
end

# ╔═╡ 0fc3eae9-467a-4305-b126-327bb3d7892c
begin
	if enabletraining
		train(0.1, 500)
	end
end

# ╔═╡ 099466a0-f47d-4aca-9520-63fdc2915332
begin
	if enabletraining
		train(0.1, 500)
	end
end

# ╔═╡ 0eaadc9e-e4c9-49cc-a65e-8fd805eacaa1
begin
	if enabletraining
		train(0.1, 500)
	end
end

# ╔═╡ 3e9dc0b1-aff1-4b5f-a78c-d42269b247e8
begin
	if enabletraining
		train(0.1, 500)
	end
end

# ╔═╡ a5ccef36-cd09-4403-bed2-4aa406039ebb
begin
	if enabletraining
		train(0.1, 500)
	end
end

# ╔═╡ 95e10df6-c448-4dae-b400-b6dcfeaf7438
begin
	if enabletraining
		train(0.1, 500)
	end
end

# ╔═╡ ccaa1092-915b-4b14-b0e2-eae663cb5b92
begin
	if enabletraining
		train(0.1, 500)
	end
end

# ╔═╡ 4d728103-4753-40f6-ab8a-29261d6813e9
begin
	if enabletraining
		train(0.1, 500)
	end
end

# ╔═╡ 2d7a69b7-ee51-4fbf-8ce1-40ce3fff751e
begin
	if enabletraining
		train(0.05, 500)
	end
end

# ╔═╡ 794b30ff-f409-4c2e-923f-789353306cda
begin
	if enabletraining
		train(0.05, 500)
	end
end

# ╔═╡ f3f493de-256b-4cd9-ab16-db88b45df937
begin
	if enabletraining
		train(0.05, 500)
	end
end

# ╔═╡ ea8190e8-2147-4846-92f3-531796efacdd
begin
	if enabletraining
		train(0.05, 500)
	end
end

# ╔═╡ 78fafa9b-8fcb-455f-ba8d-fee5e511cda5
begin
	if enabletraining
		train(0.05, 500)
	end
end

# ╔═╡ 8773bfa2-fd50-4409-be0b-d550b0686e8a
begin
	if enabletraining
		train(0.05, 500)
	end
end

# ╔═╡ 322b71cc-7499-4384-9962-25f54c0d3572
begin
	if enabletraining
		train(0.05, 500)
	end
end

# ╔═╡ f4159b1c-0b3e-418e-9486-d3584da4dd29
begin
	if enabletraining
		train(0.05, 500)
	end
end

# ╔═╡ 73b1b46f-2101-4da3-934a-ea8710a52cb4
begin
	if enabletraining
		train(0.05, 500)
	end
end

# ╔═╡ 810228ad-fe76-47a9-b54c-c1afd8de9e2a
begin
	if enabletraining
		train(0.05, 500)
	end
end

# ╔═╡ b24aef95-9e67-42b2-b83e-295ca5e967d9
begin
	if enabletraining
		train(0.035, 100)
	end
end

# ╔═╡ d18ea71c-efb9-4e7f-abff-a2f81d77b883
begin
	if enabletraining
		train(0.035, 100)
	end
end

# ╔═╡ c2dedddf-6ba1-43af-b446-828b392efb36
begin
	if enabletraining
		train(0.035, 1000)
	end
end

# ╔═╡ 216734d2-92e7-459d-baa0-74b4f86dfd1a
begin
	if enabletraining
		train(1f-3, 100)
	end
end

# ╔═╡ 37c22306-ee80-4625-85e2-ff4093375343
begin
	if enabletraining
		train(1f-3, 1000)
	end
end

# ╔═╡ 2961c8fb-83de-4081-b78e-17405e4ec2fc
begin
	if enabletraining
		train(1f-3, 1000)
	end
end

# ╔═╡ 2d6c7a30-56e7-4a19-a910-37adc97be19e
begin
	if enabletraining
		train(1f-3, 1000)
	end
end

# ╔═╡ d3fd0a5d-2637-48db-94c1-623f6cae9033
begin
	if enabletraining
		train(1f-3, 1000)
	end
end

# ╔═╡ 7ce64e25-e5a5-4ace-ba6b-844ef6e4ef82
show(IOContext(stdout, :limit=>false), MIME"text/plain"(), ps)

# ╔═╡ Cell order:
# ╠═67cb574d-7bd6-40d9-9dc3-d57f4226cc83
# ╠═db557c9a-24d6-4008-8225-4b8867ee93db
# ╠═b6abba94-db07-4095-98c9-443e31832e7d
# ╠═d1440209-78f7-4a9a-9101-a06ad2534e5d
# ╟─32be3e35-a529-4d16-8ba0-ec4e223ae401
# ╠═f74dd752-485b-4203-9d72-c56e55a3ef76
# ╟─cc2418c2-c355-4291-b5d7-d9019787834f
# ╠═dd03f851-2e26-4850-a7d4-a64f154d2872
# ╠═c00a97bf-5e10-4168-8d58-f4f9270258ac
# ╟─1502612c-1489-4abf-8a8b-5b2d03a68cb1
# ╠═455263ef-2f94-4f3e-8401-f0da7fb3e493
# ╟─f4651b27-135e-45f1-8647-64ab08c2e8e8
# ╠═aff1c9d9-b29b-4b2c-b3f1-1e06a9370f64
# ╠═9a5c942f-9e2d-4c6c-9cb1-b0dffd8050a0
# ╟─da11fb69-a8a1-456d-9ce7-63180ef27a83
# ╠═22453ba0-81a7-43f6-bb80-91d3c991530d
# ╠═d81ccb5f-de1c-4a01-93ce-3e7302caedc0
# ╠═b5721107-7cf5-4da3-b22a-552e3d56bcfa
# ╠═9767a8ea-bdda-43fc-b636-8681d150d29f
# ╟─39154e76-01f7-4710-8f21-6f3a7d3fcfcd
# ╠═847587ec-9297-471e-b788-7b776c05851e
# ╠═95f42c13-4a06-487c-bd35-a8d6bac9e02e
# ╠═63632673-4374-450c-a48d-493ae7a6b1ce
# ╠═016ab596-424b-4c50-b5c0-46d08aa47909
# ╠═bdf4c32c-9a2b-4814-8513-c6e16ebee69c
# ╟─0d09a662-78d3-4202-b2be-843a0669fc9f
# ╠═cdebb87f-9759-4e6b-a00a-d764b3c7fbf8
# ╠═3ec28482-2d6c-4125-8d85-4fb46b130677
# ╟─8b283d5e-1ce7-4deb-b382-6fa8e5612ef1
# ╠═c14806bd-42cf-480b-b618-bfe72183feb3
# ╟─64dc2da0-48cc-4242-bb17-449a300688c7
# ╠═df2034fd-560d-4529-836a-13745f976c1f
# ╟─4a97576c-96de-458e-b881-3f5dd140fa6a
# ╠═a1cb11fb-ec69-4ba2-9ed1-2d1a6d24ccd9
# ╟─bfabcd80-fb62-410f-8710-f577852c77df
# ╠═f0486891-b8b3-4a39-91df-1389d6f799e1
# ╠═001c318e-b7a6-48a5-bfd5-6dd0368873ac
# ╠═05568880-f931-4394-b31e-922850203721
# ╠═5b073f11-08bd-4128-85c6-7f043b60bdb8
# ╠═bd8fbd96-d945-4ba0-a389-d75d382438c5
# ╟─9ea12ddb-ff8a-4c16-b2a5-8b7603f262a3
# ╠═9346f569-d5f9-43cd-9302-1ee64ef9a030
# ╟─b98200a8-bf73-42a2-a357-af56812d01c3
# ╠═26885b24-df80-4fbf-9824-e175688f1322
# ╠═5f56cc7c-861e-41a4-b783-848623b94bf9
# ╠═88fa1b08-f0d4-4fcf-89c2-8a9f33710d4c
# ╠═f4f2c0ac-06f3-4632-b314-aa6e91bc84db
# ╠═dabf2a1f-ec78-4942-973f-4dbf9037ee7b
# ╠═38324c42-e5c7-4b59-8129-0e4c17ab5bf1
# ╠═08021ed6-ac31-4829-9f21-f046af73d5a3
# ╠═92c138d3-05f6-4a57-9b6b-08f41cb4ea55
# ╠═18acf95a-4fa2-452d-875d-01dfc7f18bac
# ╠═3d889727-ae6d-4fa0-98ae-d3ae73fb6a3c
# ╠═b5c6d43c-8252-4602-8232-b3d1b0bcee33
# ╠═025b33d9-7473-4a54-a3f1-787a8650f9e7
# ╠═f0a34be1-6aa2-4563-abc2-ea163a778752
# ╠═ef59f249-64c5-4262-b987-327d67b70422
# ╠═f4a16e34-669e-4c93-bd83-e3622a747a3a
# ╟─2ada3ddd-b47a-46ff-abba-17cbb94041a2
# ╠═5a17f6c0-ead1-448f-8df8-60e68a96e0db
# ╠═a528a99c-5f9e-4d04-abd2-6b9264fb775d
# ╠═0fc3eae9-467a-4305-b126-327bb3d7892c
# ╠═099466a0-f47d-4aca-9520-63fdc2915332
# ╠═0eaadc9e-e4c9-49cc-a65e-8fd805eacaa1
# ╠═3e9dc0b1-aff1-4b5f-a78c-d42269b247e8
# ╠═a5ccef36-cd09-4403-bed2-4aa406039ebb
# ╠═95e10df6-c448-4dae-b400-b6dcfeaf7438
# ╠═ccaa1092-915b-4b14-b0e2-eae663cb5b92
# ╠═4d728103-4753-40f6-ab8a-29261d6813e9
# ╠═2d7a69b7-ee51-4fbf-8ce1-40ce3fff751e
# ╠═794b30ff-f409-4c2e-923f-789353306cda
# ╠═f3f493de-256b-4cd9-ab16-db88b45df937
# ╠═ea8190e8-2147-4846-92f3-531796efacdd
# ╠═78fafa9b-8fcb-455f-ba8d-fee5e511cda5
# ╠═8773bfa2-fd50-4409-be0b-d550b0686e8a
# ╠═322b71cc-7499-4384-9962-25f54c0d3572
# ╠═f4159b1c-0b3e-418e-9486-d3584da4dd29
# ╠═73b1b46f-2101-4da3-934a-ea8710a52cb4
# ╠═810228ad-fe76-47a9-b54c-c1afd8de9e2a
# ╠═b24aef95-9e67-42b2-b83e-295ca5e967d9
# ╠═d18ea71c-efb9-4e7f-abff-a2f81d77b883
# ╠═c2dedddf-6ba1-43af-b446-828b392efb36
# ╠═216734d2-92e7-459d-baa0-74b4f86dfd1a
# ╠═37c22306-ee80-4625-85e2-ff4093375343
# ╠═2961c8fb-83de-4081-b78e-17405e4ec2fc
# ╠═2d6c7a30-56e7-4a19-a910-37adc97be19e
# ╠═d3fd0a5d-2637-48db-94c1-623f6cae9033
# ╠═7ce64e25-e5a5-4ace-ba6b-844ef6e4ef82
